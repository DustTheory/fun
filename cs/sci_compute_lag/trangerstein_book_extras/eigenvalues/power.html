<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Power Method for Symmetric Tridiagonal Matrix </TITLE>
  </HEAD>
  <BODY>
    <h2> Power Method for Symmetric Tridiagonal Matrix </h2>
    <script src=../linear_algebra/LaPack0.js></script>
    <script src=../linear_algebra/LaPack1.js></script>
    <script src=../linear_algebra/BooleanReference.js></script>
    <script src=../linear_algebra/IntReference.js></script>
    <script src=../linear_algebra/JSVector.js></script>
    <script src=../linear_algebra/LaPack0.js></script>
    <script src=../linear_algebra/NumberReference.js></script>
    <script language="javascript">
    var diagonal_text = "6;5;4;3;2";
    var subdiagonal_text = "-1;-1;-1;-1";
    var d = new JSVector();
    var e = new JSVector();
    var shift = 0.;
    var type = 0;
    var lambda = undefined;
    var first_iteration = true;

    function eigenvectorResidual( lambda, p ) {
//    document.getElementById("debug_textarea").value +=
//      "entering eigenvectorResidual, lambda = " + lambda + "\n";
      var n = d.length();
      var r = new JSVector( n, 0. );
      r.setEntry( 0, ( d.getEntry( 0 ) - lambda ) * p.getEntry( 0 )
                   + e.getEntry( 0 ) * p.getEntry( 1 ) );
      for ( var j = 1; j < n - 1; j ++ ) {
        r.setEntry( j, ( d.getEntry( j ) - lambda ) * p.getEntry( j )
          + e.getEntry( j - 1 ) * p.getEntry( j - 1 )
          + e.getEntry( j ) * p.getEntry( j + 1 ) );
      }
      r.setEntry( n - 1,
        ( d.getEntry( n - 1 ) - lambda ) * p.getEntry( n - 1 )
        + e.getEntry( n - 2 ) * p.getEntry( n - 2 ) );
      r.divideEquals( p.norm(2) );
//    document.getElementById("debug_textarea").value +=
//      "leaving eigenvectorResidual, r = " + r.toString() + "\n";
      return r;
    }
    function iterate() {
      var n = d.length();
//    document.getElementById("debug_textarea").value +=
//      "entering iteration, type = " + type + " \n";
      switch ( type ) {
        default:
        case 0 : { // power method
          var ax = new JSVector( n );
          var dshift = new JSVector( n );
            for ( var i = 0; i < n; i ++ ) {
              dshift.setEntry( i, d.getEntry( i ) - shift );
            }
          ax.setEntry( 0, dshift.getEntry( 0 ) * x.getEntry( 0 )
                        + e.getEntry( 0 ) * x.getEntry( 1 ) );
          var lambda = shift + x.getEntry( 0 ) * ax.getEntry( 0 );
          for ( var i = 1; i < n - 1; i ++ ) {
            ax.setEntry( i, e.getEntry( i - 1 ) * x.getEntry( i - 1 )
                          + dshift.getEntry( i ) * x.getEntry( i )
                          + e.getEntry( i ) * x.getEntry( i + 1 ) );
            lambda += x.getEntry( i ) * ax.getEntry( i );
          }
          ax.setEntry( n - 1, e.getEntry( n - 2 ) * x.getEntry( n - 2 )
                        + dshift.getEntry( n - 1 ) * x.getEntry( n - 1 ) );
          lambda += x.getEntry( n - 1 ) * ax.getEntry( n - 1 );
          x.copy( ax );
          x.divideEquals( ax.norm(2) );
          var r = eigenvectorResidual( lambda, x );
          document.getElementById("debug_textarea").value =
            "power method \n";
          document.getElementById("debug_textarea").value +=
            "lambda = " + lambda + "\n";
          document.getElementById("debug_textarea").value +=
            "x = " + x.toString() + "\n";
          document.getElementById("debug_textarea").value +=
            "residual = " + r.toString() + "\n";
          document.getElementById("debug_textarea").value +=
            "residual norm = " + r.norm(2) + "\n";
          return;
        }
        case 1 : { // inverse iteration
          var dl = new JSVector( n - 1 );
            dl.copy( e );
          var dshift = new JSVector( n );
            for ( var i = 0; i < n; i ++ ) {
              dshift.setEntry( i, d.getEntry( i ) - shift );
            }
          var du = new JSVector( n - 1 );
            du.copy( e );
          var du2 = new JSVector( n - 2 );
          var ipiv = new JSVector( n );
          var info = new NumberReference(0);
          LaPack0.dgttrf( n, dl.dataArray(), dshift.dataArray(),
            du.dataArray(), du2.dataArray(), ipiv.dataArray(), info,
            0, 0, 0, 0, 0 );
          if ( info.getValue() != 0 ) {
            document.getElementById("debug_textarea").value =
              "bad shift: singular matrix\n";
            return;
          }
          var ainvx = new JSVector( n );
          ainvx.copy( x );
          LaPack1.dgttrs( 'N', n, 1, dl.dataArray(), dshift.dataArray(),
            du.dataArray(), du2.dataArray(), ipiv.dataArray(),
            ainvx.dataArray(), n, info, 0, 0, 0, 0, 0, 0 );
          var lambda = 0;
          for ( var i = 0; i < n; i ++ ) {
            lambda += x.getEntry( i ) * ainvx.getEntry( i );
          }
          lambda = 1. / lambda + shift;
          x.copy( ainvx );
          x.divideEquals( ainvx.norm(2) );
          var r = eigenvectorResidual( lambda, x );
          document.getElementById("debug_textarea").value =
            "inverse iteration \n";
          document.getElementById("debug_textarea").value +=
            "lambda = " + lambda + "\n";
          document.getElementById("debug_textarea").value +=
            "x = " + x.toString() + "\n";
          document.getElementById("debug_textarea").value +=
            "residual = " + r.toString() + "\n";
          document.getElementById("debug_textarea").value +=
            "residual norm = " + r.norm(2) + "\n";
          return;
        }
        case 2 : { // Rayleigh quotient iteration
          var lambda = undefined;
          if ( first_iteration ) lambda = shift;
          else {
            var ax = new JSVector( n );
            ax.setEntry( 0, d.getEntry( 0 ) * x.getEntry( 0 )
                          + e.getEntry( 0 ) * x.getEntry( 1 ) );
            lambda = x.getEntry( 0 ) * ax.getEntry( 0 );
            for ( var i = 1; i < n - 1; i ++ ) {
              ax.setEntry( i, e.getEntry( i - 1 ) * x.getEntry( i - 1 )
                            + d.getEntry( i ) * x.getEntry( i )
                            + e.getEntry( i ) * x.getEntry( i + 1 ) );
              lambda += x.getEntry( i ) * ax.getEntry( i );
            }
            ax.setEntry( n - 1, e.getEntry( n - 2 ) * x.getEntry( n - 2 )
                              + d.getEntry( n - 1 ) * x.getEntry( n - 1 ) );
            lambda += x.getEntry( n - 1 ) * ax.getEntry( n - 1 );
          }
          var dl = new JSVector( n - 1 );
            dl.copy( e );
          var dshift = new JSVector( n );
            for ( var i = 0; i < n; i ++ ) {
              dshift.setEntry( i, d.getEntry( i ) - lambda );
            }
          var du = new JSVector( n - 1 );
            du.copy( e );
          var du2 = new JSVector( n - 2 );
          var ipiv = new JSVector( n );
          var info = new NumberReference(0);
          LaPack0.dgttrf( n, dl.dataArray(), dshift.dataArray(),
            du.dataArray(), du2.dataArray(), ipiv.dataArray(), info,
            0, 0, 0, 0, 0 );
          if ( info.getValue() != 0 ) {
            if ( first_iteration ) {
              document.getElementById("debug_textarea").value =
                "bad shift: singular matrix\n";
            } else {
              document.getElementById("debug_textarea").value =
                "Rayleigh quotient shift is a numerical eigenvalue\n";
              document.getElementById("debug_textarea").value +=
                "Rayleigh quotient = " + lambda + "\n";
              document.getElementById("debug_textarea").value +=
                "x = " + x.toString() + "\n";
            }
            return;
          }
          var ainvx = new JSVector( n );
          ainvx.copy( x );
          LaPack1.dgttrs( 'N', n, 1, dl.dataArray(), dshift.dataArray(),
            du.dataArray(), du2.dataArray(), ipiv.dataArray(),
            ainvx.dataArray(), n, info, 0, 0, 0, 0, 0, 0 );

          x.copy( ainvx );
          x.divideEquals( ainvx.norm(2) );
          var r = eigenvectorResidual( lambda, x );
          document.getElementById("debug_textarea").value =
            "Rayleigh quotient iteration \n";
          document.getElementById("debug_textarea").value +=
            "lambda = " + lambda + "\n";
          document.getElementById("debug_textarea").value +=
            "x = " + x.toString() + "\n";
          document.getElementById("debug_textarea").value +=
            "residual = " + r.toString() + "\n";
          document.getElementById("debug_textarea").value +=
            "residual norm = " + r.norm(2) + "\n";
          first_iteration = false;
          return;
        }
      }
    }
    function onStart() {
//    document.getElementById("debug_textarea").value +=
//      "entering onStart\n";
      var radio_buttons =
        document.getElementsByName("iteration_radiobox");
      type = 0;
      for ( var i = 0; i < radio_buttons.length; i ++ ) {
        if ( radio_buttons[ i ].checked ) {
          type = Number( radio_buttons[ i ].value );
          break;
        }
      }
//    document.getElementById("debug_textarea").value +=
//      "type = " + type + "\n";
      d.parse( diagonal_text );
      e.parse( subdiagonal_text );
      shift = Number( shift );
      lambda = undefined;
      first_iteration = true;
      x = new JSVector( d.length(), 0. );
      for ( var i = 0; i < x.length(); i ++ ) {
        x.setEntry( i, Math.random() );
      }
      x.divideEquals( x.norm(2) );
//    document.getElementById("debug_textarea").value +=
//      "leaving onStart\n";
    }

    function checkNumber(n) {
      if (!isFinite(n)) {
        alert("entered value is not a NUMBER");
        return false;
      }
      return true;
    }
    function scientificFormat( n ) {
      var an = Math.abs(n);
      if ( an>=0.01 && an<=100. ) return n.toString();
      else return n.toExponential();
    }
    </script>
      diagonal =
      <input
        type="text"
        name="diagonal_text"
        value="6;5;4;3;2"
        size="50"
      >
      <br>
      sub-diagonal =
      <input
        type="text"
        name="subdiagonal_text"
        value="-1;-1;-1;-1"
        size="50"
      >
    <br>
    shift = 
    <input
      type="number"
      name="shift"
      value="0"
      onchange="checkNumber(document.getElementsByName('shift')[0].value);"
      size=20
    >
    <br>
    <fieldset>
      <legend> Type of iteration: </legend>
      <label for="power method">
        <input
        type="radio"
        checked value="0"
        id="power_option_checkbox"
        name="iteration_radiobox"
        />
        Power Method
      </label>
      <label for="inverse iteration">
        <input
        type="radio"
        checked value="1"
        id="inverse_option_checkbox"
        name="iteration_radiobox"
        />
        Inverse Iteration
      </label>
      <label for="Rayleight quotient iteration">
        <input
        type="radio"
        checked value="2"
        id="rayleigh_option_checkbox"
        name="iteration_radiobox"
        />
        Rayleigh Quotient Iteration
      </label>
    </fieldset>
    <input
      type="button"
      value="Iterate"
      onclick="iterate();"
    >
    <input
      type="button"
      value="Start Over"
      onclick="diagonal_text=document.getElementsByName('diagonal_text')[0].value;subdiagonal_text=document.getElementsByName('subdiagonal_text')[0].value;shift=document.getElementsByName('shift')[0].value;onStart();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=7
    >
    </textarea>
<!--
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
