<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> QR Method for General Matrix </TITLE>
  </HEAD>
  <BODY>
    <h2> QR Method for General Matrix </h2>
    <script src=../linear_algebra/Blas1.js></script>
    <script src=../linear_algebra/Blas2.js></script>
    <script src=../linear_algebra/BooleanReference.js></script>
    <script src=../linear_algebra/IntReference.js></script>
    <script src=../linear_algebra/JSVector.js></script>
    <script src=../linear_algebra/JSMatrix.js></script>
    <script src=../linear_algebra/LaPack0.js></script>
    <script src=../linear_algebra/LaPack1.js></script>
    <script src=../linear_algebra/LaPack2.js></script>
    <script src=../linear_algebra/LaPack3.js></script>
    <script src=../linear_algebra/NumberReference.js></script>
    <script language="javascript">
//  var matrix_text = "6,5,-5;2,6,-2;2,5,-1";
    var matrix_text = "14,2,-2,6;-2,14,-6,-2;-2,6,14,2;-6,-2,-2,14";
    var A = new JSMatrix();
    var wr = new JSVector();
    var wi = new JSVector();
    var n = undefined;
    var itmax = undefined;
    var dat1 = undefined;
    var dat2 = undefined;
    var v = new Array( );
    var nh = undefined;
    var nz = undefined;
    var safmin = undefined;
    var safmax =  undefined;
    var ulp = undefined;
    var smlnum = undefined;
    var i1 = undefined;
    var i2 = undefined;
    var i = undefined;
    var its = undefined;
    var goto150 = false;

    function printMatrix() {
      var sa = new Array( n * n );
      var cw = new Array( n );
      for ( var j = 0; j < n; j ++ ) {
        cw[ j ] = 0;
        for ( var i = 0; i < n; i ++ ) {
          sa[ i + j * n ] = 
            scientificFormat( A.getEntry( i, j ) );
          cw[ j ]=Math.max( sa[ i + j * n ].length, cw[ j ] );
        }
      }
      for ( var i = 0; i < n; i ++ ) {
        var str = new String();
        for ( var j = 0; j < n; j ++ ) {
          var sj = sa[ i + j * n ];
          while ( sj.length < cw[ j ] ) sj += ' ';
          str += sj + ' ';
        }
        document.getElementById("debug_textarea").value += str + "\n";
      }
    }
    function printUpperHessenbergMatrix() {
        document.getElementById("schur_textarea").value = "";
      var sa = new Array( n * n );
      var cw = new Array( n );
      for ( var j = 0; j < n; j ++ ) {
        cw[ j ] = 0;
        for ( var i = 0; i < Math.min( n, j + 2 ); i ++ ) {
          sa[ i + j * n ] = 
            scientificFormat( A.getEntry( i, j ) );
          cw[ j ]=Math.max( sa[ i + j * n ].length, cw[ j ] );
        }
      }
      for ( var i = 0; i < n; i ++ ) {
        var str = new String();
        for ( var j = 0; j < Math.max( 0, i - 1 ); j ++ ) {
          var sj = '';
          while ( sj.length < cw[ j ] ) sj = ' ' + sj;
          str += sj + ' ';
        }
        for ( var j = Math.max( 0, i - 1 ); j < n; j ++ ) {
          var sj = sa[ i + j * n ];
          while ( sj.length < cw[ j ] ) sj += ' ';
          str += sj + ' ';
        }
        document.getElementById("schur_textarea").value += str + "\n";
      }
    }
    function iterate() {
//    loop 20 of LaPack2.dlahqr
      var l = 1;
//    document.getElementById("debug_textarea").value +=
//      "entering iterate, i,l = " + i + " " + l + "\n";
//    printMatrix();
      if ( i < 1 ) return;
//    for ( var its = 0; its <= itmax; its ++ ) {
        for ( var k = i; k >= l + 1; k -- ) { // loop 30
          if ( Math.abs( A.getEntry( k - 1 , k - 2 ) ) <= smlnum ) break;
          var tst = Math.abs( A.getEntry( k - 2 , k - 2 ) )
                  + Math.abs( A.getEntry( k - 1 , k - 1 ) );
          if ( tst == 0. ) {
            if ( k - 2 >= 1 ) {
              tst += Math.abs( A.getEntry( k - 2 , k - 3 ) );
            }
            if ( k + 1 <= n ) tst += Math.abs( A.getEntry( k , k - 1 ) );
          }
          var Hkkm1 = A.getEntry( k - 1 , k - 2 );
//        document.getElementById("debug_textarea").value +=
//          "after loop 30, k,tst,ulp,Hkkm1 = " + k + " " + tst + " "
//          + ulp + " " + Hkkm1 + "\n";
          if ( Math.abs( A.getEntry( k - 1 , k - 2 ) ) <= ulp * tst ) {
            var ab = Math.max(
              Math.abs( A.getEntry( k - 1 , k - 2 ) ),
              Math.abs( A.getEntry( k - 2 , k - 1 ) ) );
            var ba = Math.min(
              Math.abs( A.getEntry( k - 1 , k - 2 ) ),
              Math.abs( A.getEntry( k - 2 , k - 1 ) ) );
            var aa = Math.max(
              Math.abs( A.getEntry( k - 1 , k - 1 ) ),
              Math.abs( A.getEntry( k - 2 , k - 2 ) 
                      - A.getEntry( k - 1 , k - 1 ) ) );
            var bb = Math.min(
              Math.abs( A.getEntry( k - 1 , k - 1 ) ),
              Math.abs( A.getEntry( k - 2 , k - 2 ) 
                      - A.getEntry( k - 1 , k - 1 ) ) );
            var s = aa + bb;
//          document.getElementById("debug_textarea").value +=
//            "ab,ba,aa,bb,s = " + ab + " " + ba + " " + aa + " " + bb + " "
//            + s + "\n"; 
            if ( ba * ( ab / s ) <=
            Math.max( smlnum, ulp * ( bb * ( aa / s ) ) ) ) {
//            document.getElementById("debug_textarea").value += "break\n";
              break;
            }
          }
        } // 30
        l = k;
        if ( l > 1 ) {
          A.setEntry( l - 1 , l - 2 , 0. );
          var Hllm1 = A.getEntry( l - 1 , l - 2 );
//        document.getElementById("debug_textarea").value +=
//          "l,Hllm1 = " + l + " " + Hllm1 + "\n";
        }
        if ( l >= i - 1 ) {
//        document.getElementById("debug_textarea").value += "goto 150\n";
          goto150 = true;
//        break;
        }
        if ( ! goto150 ) {
          i1 = l;
          i2 = i;
//        document.getElementById("debug_textarea").value +=
//          "i1,i2,its = " + i1 + " " + i2 + " " + its + "\n";
          if ( its == 10 ) {
            s = Math.abs( A.getEntry( l , l - 1 ) )
              + Math.abs( A.getEntry( l + 1 , l ) );
            var h11 = dat1 * s + A.getEntry( l - 1 , l - 1 );
            var h12 = dat2 * s;
            var h21 = s;
            var h22 = h11;
          } else if ( its == 20 ) {
            s = Math.abs( A.getEntry( i - 1, i - 2 ) )
              + Math.abs( A.getEntry( i - 2 , i - 3 ) );
            h11 = dat1 * s + A.getEntry( i - 1 , i - 1 );
            h12 = dat2 * s;
            h21 = s;
            h22 = h11;
          } else {
            h11 = A.getEntry( i - 2 , i - 2 );
            h21 = A.getEntry( i - 1 , i - 2 );
            h12 = A.getEntry( i - 2 , i - 1 );
            h22 = A.getEntry( i - 1 , i - 1 );
          }
          s = Math.abs( h11 ) + Math.abs( h12 )
            + Math.abs( h21 ) + Math.abs( h22 );
//        document.getElementById("debug_textarea").value +=
//          "h11,h12,h21,h22,s = " + h11 + " " + h12 + " " + h21 + " "
//          + h22 + " " + s + "\n";
          if ( s == 0. ) {
            var rt1r = 0.;
            var rt1i = 0.;
            var rt2r = 0.;
            var rt2i = 0.;
          } else {
            h11 /= s;
            h21 /= s;
            h12 /= s;
            h22 /= s;
            var tr = ( h11 + h22 ) / 2.;
            var det = ( h11 - tr ) * ( h22 - tr ) - h12 * h21;
            var rtdisc = Math.sqrt( Math.abs( det ) );
            if ( det >= 0. ) {
              rt1r = tr * s;
              rt2r = rt1r;
              rt1i = rtdisc * s;
              rt2i = - rt1i;
            } else {
              rt1r = tr + rtdisc;
              rt2r = tr - rtdisc;
              if ( Math.abs( rt1r - h22 ) <= Math.abs( rt2r - h22 ) ) {
                rt1r *= s;
                rt2r = rt1r;
              } else {
                rt2r *= s;
                rt1r = rt2r;
              }
              rt1i=0.;
              rt2i=0.;
            }
          }
//        document.getElementById("debug_textarea").value +=
//          "rt1r,rt1i,rt2r,rt2i = " + rt1r + " " + rt1i + " " + rt2r + " "
//          + rt2i + "\n";
          for ( var m = i - 2; m >= l; m -- ) {
            var h21s = A.getEntry( m , m - 1 );
            s = Math.abs( A.getEntry( m - 1 , m - 1 ) - rt2r )
              + Math.abs( rt2i ) + Math.abs( h21s );
            h21s = A.getEntry( m , m - 1 ) / s;
            v[ 0 ] = h21s * A.getEntry( m - 1 , m )
              + ( A.getEntry( m - 1 , m - 1 ) - rt1r )
              * ( ( A.getEntry( m - 1 , m - 1 ) - rt2r ) / s )
              - rt1i * ( rt2i / s );
            v[ 1 ] = h21s * ( A.getEntry( m - 1 , m - 1 )
              + A.getEntry( m , m ) - rt1r - rt2r );
            v[ 2 ] = h21s * A.getEntry( m + 1 , m );
            s = Math.abs( v[ 0 ] ) + Math.abs( v[ 1 ] )
              + Math.abs( v[ 2 ] );
            v[ 0 ] /= s;
            v[ 1 ] /= s;
            v[ 2 ] /= s;
//          document.getElementById("debug_textarea").value +=
//            "h21s,s,v = " + h21s + " " + s + " " + v[ 0 ] + " " + v[ 1 ]
//            + " " + v[ 2 ] + "\n";
            if ( m == l ) break;
            if ( Math.abs( A.getEntry( m - 1 , m - 2 ) )
            * ( Math.abs( v[ 1 ] ) + Math.abs( v[ 2 ] ) ) <=
            ulp * Math.abs( v[ 0 ] )
            * ( Math.abs( A.getEntry( m - 2 , m - 2 ) )
            + Math.abs( A.getEntry( m - 1 , m - 1 ) )
            + Math.abs( A.getEntry( m , m ) ) ) ) {
              break;
            }
          } // 50
          for ( k == m; k <= i - 1; k ++ ) {
            var nr = Math.min( 3, i - k + 1 );
            if ( k > m ) {
              Blas1.dcopy( nr, A.dataArray(), 1, v, 1,
                k - 1 + ( k - 2 ) * n, 0 );
            }
//          document.getElementById("debug_textarea").value +=
//            "k,nr,v = " + k + " " + nr + " " + v[0] + " " + v[1] + " "
//            + v[2] + "\n";
            var alpha = new NumberReference( v[ 0 ] );
            var t1 = new NumberReference();
            LaPack1.dlarfg( nr, alpha, v, 1, t1, 1 );
            v[ 0 ] = alpha.getValue();
//          document.getElementById("debug_textarea").value +=
//            "t1,v = " + t1.getValue() + " " + v[0] + " " + v[1] + " "
//            + v[2] + "\n";
            if ( k > m ) {
              A.setEntry( k - 1 , k - 2 , v[ 0 ] );
              A.setEntry( k , k - 2 , 0. );
              if ( k < i - 1 ) A.setEntry( k + 1 , k - 2 , 0. );
            } else if ( m > l ) {
              A.setEntry( k - 1 , k - 2 ,
                A.getEntry( k - 1, k - 2 ) * ( 1. - t1.getValue() ) );
            }
            var v2 = v[ 1 ];
            var t2 = t1.getValue() * v2;
//          document.getElementById("debug_textarea").value +=
//            "v2,t2 = " + v2 + " " + t2 + "\n";
            if ( nr == 3 ) {
              var v3 = v[ 2 ];
              var t3 = t1.getValue() * v3;
              for ( j = k; j <= i2; j ++ ) {
                var sum = A.getEntry( k - 1 , j - 1 )
                  + v2 * A.getEntry( k , j - 1 )
                  + v3 * A.getEntry( k + 1 , j - 1 );
                A.setEntry( k - 1 , j - 1 ,
                  A.getEntry( k - 1 , j - 1 ) -  sum * t1.getValue() );
                A.setEntry( k , j - 1 ,
                  A.getEntry( k , j - 1 ) - sum * t2 );
                A.setEntry( k + 1 , j - 1 ,
                  A.getEntry( k + 1 , j - 1 ) - sum * t3 );
              }
              for ( j = i1; j <= Math.min( k + 3, i ); j ++ ) {
                sum = A.getEntry( j - 1 , k - 1 )
                    + v2 * A.getEntry( j - 1 , k )
                    + v3 * A.getEntry( j - 1 , k + 1 );
                A.setEntry( j - 1 , k - 1 ,
                  A.getEntry( j - 1 , k - 1 ) - sum * t1.getValue() );
                A.setEntry( j - 1 , k ,
                  A.getEntry( j - 1 , k ) - sum * t2 );
                A.setEntry( j - 1 , k + 1 ,
                  A.getEntry( j - 1 , k + 1 ) - sum * t3 );
              }
            } else if ( nr == 2 ) {
              for ( j = k; j <= i2; j ++ ) {
                sum = A.getEntry( k - 1 , j - 1 )
                    + v2 * A.getEntry( k , j - 1 );
                A.setEntry( k - 1 , j - 1 , 
                  A.getEntry( k - 1 , j - 1 ) - sum * t1.getValue() );
                A.setEntry( k , j - 1 ,
                  A.getEntry( k , j - 1 ) - sum * t2 );
              }
              for ( j = i1; j <= i; j ++ ) {
                sum = A.getEntry( j - 1 , k - 1 )
                    + v2 * A.getEntry( j - 1 , k);
                A.setEntry( j - 1 , k - 1 ,
                  A.getEntry( j - 1 , k - 1 ) - sum * t1.getValue() );
                A.setEntry( j - 1 , k ,
                  A.getEntry( j - 1 , k ) - sum * t2 );
              }
            }
//          document.getElementById("debug_textarea").value +=
//            "nr == " + nr + ", H = \n";
//          for ( var ii = 0; ii < n; ii ++ ) {
//            for ( var jj = 0; jj < n; jj ++ ) {
//              document.getElementById("debug_textarea").value +=
//                A.getEntry( ii, jj ) + " ";
//            }
//            document.getElementById("debug_textarea").value += "\n";
//          }
          } // 130
        }
//    }
      printUpperHessenbergMatrix();
      if ( ! goto150 ) {
//      info.setValue( i );
        its ++;
        return;
      }
      if ( l == i ) {
//      document.getElementById("debug_textarea").value +=
//        "l == i = " + l + " one eigenvalue converged\n";
        wr[ i - 1 ] = A.getEntry( i - 1 , i - 1 );
        wi[ i - 1 ] = 0.;
      } else if ( l == i - 1 ) {
        var a = new NumberReference( A.getEntry( i - 2 , i - 2 ) );
        var b = new NumberReference( A.getEntry( i - 2 , i - 1 ) );
        var c = new NumberReference( A.getEntry( i - 1 , i - 2 ) );
        var d = new NumberReference( A.getEntry( i - 1 , i - 1 ) );
//      document.getElementById("debug_textarea").value +=
//        "l == i - 1 = " + l + " two eigenvalues converged\n";
//      document.getElementById("debug_textarea").value +=
//        "a,b,c,d = " + a.getValue() + " " + b.getValue() + " "
//        + c.getValue() + " " + d.getValue() + "\n";
        var rt1rref = new NumberReference();
        var rt1iref = new NumberReference();
        var rt2rref = new NumberReference();
        var rt2iref = new NumberReference();
        var cs = new NumberReference();
        var sn = new NumberReference();
        LaPack1.dlanv2( a, b, c, d, rt1rref, rt1iref, rt2rref, rt2iref,
          cs, sn );
        A.setEntry( i - 2 , i - 2 , a.getValue() );
        A.setEntry( i - 2 , i - 1 , b.getValue() );
        A.setEntry( i - 1 , i - 2 , c.getValue() );
        A.setEntry( i - 1 , i - 1 , d.getValue() );
//      document.getElementById("debug_textarea").value +=
//        "a,b,c,d = " + a.getValue() + " " + b.getValue() + " "
//        + c.getValue() + " " + d.getValue() + "\n";
//      document.getElementById("debug_textarea").value +=
//        "rt1r,rt1i,rt2r,rt2i = " + rt1rref.getValue() + " "
//        + rt1iref.getValue() + " " + rt2rref.getValue() + " "
//        + rt2iref.getValue()+ "\n";
        wr[ i - 2 ] = rt1rref.getValue();
        wi[ i - 2 ] = rt1iref.getValue();
        wr[ i - 1 ] = rt2rref.getValue();
        wi[ i - 1 ] = rt2iref.getValue();
        if ( i2 > i ) {
          Blas1.drot( i2 - i, A.dataArray(), n, A.dataArray(), n,
            cs.getValue(), sn.getValue(), i - 2 + i * n, i - 1 + i * n );
        }
        Blas1.drot( i - i1 - 1, A.dataArray(), 1, A.dataArray(), 1,
          cs.getValue(), sn.getValue(), i1 - 1 + ( i - 2 ) * n,
          i1 - 1 + ( i - 1 ) * n );
//      document.getElementById("debug_textarea").value += "H = \n";
//      for ( var ii = 0; ii < n; ii ++ ) {
//        for ( var jj = 0; jj < n; jj ++ ) {
//          document.getElementById("debug_textarea").value +=
//            A.getEntry(ii,jj) + " ";
//        }
//        document.getElementById("debug_textarea").value += "\n";
//      }
      }
      i = l - 1;
      goto150 = false;
      its = 1;
      if ( i < 1 ) {
        printUpperHessenbergMatrix();
        document.getElementById("debug_textarea").value =
          "iteration terminated: eigenvalues =\n";
        for ( var ii = 0; ii < n; ii ++ ) {
          document.getElementById("debug_textarea").value +=
            wr[ ii ] + " + I * " + wi[ ii ] + "\n";
        }
      }
//    document.getElementById("debug_textarea").value +=
//      "leaving iterate\n";
//    printMatrix();
    }
    function onStart() {
      document.getElementById("debug_textarea").value = "";
//    document.getElementById("debug_textarea").value +=
//      "entering onStart\n";
      A.parse( matrix_text );
      n = A.numberRows();
//    document.getElementById("debug_textarea").value +=
//      "A = " + A.toString() + "\n";
      
//    from dgeev:
      var tau = new Array( n );
      var work = new Array( n );
      var info = new IntReference();
      LaPack3.dgehrd( n, 1, n, A.dataArray(), n, tau, work, n, info,
        0, 0, 0 );
      printUpperHessenbergMatrix();

//    throw away transformation to upper Hessenberg form:
      for ( var ii = 0; ii < n; ii ++ ) {
        for ( var jj = 0 ; jj < Math.max( 0, ii - 1 ); jj ++ ) {
          A.setEntry( ii, jj, 0. );
        }
      }
//    document.getElementById("debug_textarea").value +=
//      "H = " + A.toString() + "\n";

//    from LaPack9.dhseqr:
//    var ntiny = 11;
//    var nl = 49;
//    var Hl = new Array( nl * nl );
//    var workl = new Array ( nl );
//    wantt = true;
//    var initz = false;
//    var wantz = false;
      if ( n == 0 ) return;
      wr = new JSVector( n, 0. );
      wi = new JSVector( n, 0. );
      if ( n == 1 ) {
        wr.setEntry( 0 ) = A.getEntry( 0, 0 );
        wi.setEntry( 0 ) = 0.;
        return;
      }
//    from LaPack2.dlahqr:
      itmax = 30;
      its = 1;
      dat1 = 0.75;
      dat2 = -0.4375;
      v = new Array( 3 );
      for ( j = 1; j <= n - 3; j ++ ) {
        A.setEntry( j + 1, j - 1 , 0. );
        A.setEntry( j + 2, j - 1 , 0. );
      }
      if ( 1 <= n - 2 ) A.setEntry( n - 1, n - 3 , 0. );
//    document.getElementById("debug_textarea").value += "H = \n";
//    for ( var ii = 0; ii < n; ii ++ ) {
//      for ( var jj = 0; jj < n; jj ++ ) {
//        document.getElementById("debug_textarea").value +=
//          A.getEntry(ii,jj) + " ";
//      }
//      document.getElementById("debug_textarea").value += "\n";
//    }
      nh = n;
      nz = n;
      safmin = new NumberReference( LaPack0.dlamch( 'Safe minimum' ) );
      safmax = new NumberReference( 1. / safmin.getValue() );
      LaPack0.dlabad( safmin, safmax );
      ulp = LaPack0.dlamch( 'Precision' );
      smlnum = safmin.getValue() * ( Number( nh ) / ulp );
//    document.getElementById("debug_textarea").value +=
//      "nh,nz,safmin,safmax,ulp,smlnum = " + nh + " " + nz + " "
//      + safmin + " " + safmax + " " + ulp + " " + smlnum + "\n";
      i1 = 1;
      i2 = n;
      i = n;
//    document.getElementById("debug_textarea").value +=
//      "i1,i2,i = " + i1 + " " + i2 + " " + i + "\n";
      goto150 = false;
      iterate();

//    document.getElementById("debug_textarea").value +=
//      "leaving onStart\n";
    }

    function checkNumber(n) {
      if (!isFinite(n)) {
        alert("entered value is not a NUMBER");
        return false;
      }
      return true;
    }
    function scientificFormat( n ) {
      var an = Math.abs(n);
      if ( an>=0.01 && an<=100. ) return n.toString();
      else return n.toExponential();
    }
    </script>
    original matrix =
    <input
      type="text"
      name="matrix_text"
      value="14,2,-2,6;-2,14,-6,-2;-2,6,14,2;-6,-2,-2,14"
      size="50"
    >
    <br>
    <input
      type="button"
      value="Iterate"
      onclick="iterate();"
    >
    <input
      type="button"
      value="Start Over"
      onclick="matrix_text=document.getElementsByName('matrix_text')[0].value;onStart();"
    >
    <br>
    upper Hessenberg matrix :
    <textarea
      id="schur_textarea"
      cols=150
      rows=10
    >
    </textarea>
    <br>
    <textarea
      id="debug_textarea"
      cols=150
      rows=11
    >
    </textarea>
<!--
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
