<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Successive Orthogonal Projection </TITLE>
  </HEAD>
  <BODY>
    <h2> Successive Orthogonal Projection </h2>
    <script src=../linear_algebra/JSMatrix.js></script>
    <script src=../linear_algebra/JSVector.js></script>
    <script src=../linear_algebra/Blas1.js></script>
    <script src=../linear_algebra/Blas2.js></script>
    <script language="javascript">
    var matrix_text="1,1;1.e-10,0;0,1.e-10";
    var rhs_text="1;0;0";

    function factorMatrix( ) {
//    document.getElementById("debug_textarea").value +=
//      "entering factorMatrix\n";
      document.getElementById("q_factor_textarea").value="";
      document.getElementById("r_factor_textarea").value="";
      document.getElementById("x_textarea").value="";
      document.getElementById("r_textarea").value="";
      document.getElementById("b_minus_Ax_textarea").value="";
      document.getElementById("Atranspose_r_textarea").value="";
      var A = new JSMatrix();
      A.parse( matrix_text );
      var m = A.numberRows();
      var n = A.numberCols();

      var Q = new JSMatrix();
      Q.copy( A );
      var R = new JSMatrix( n, n, 0 );

      var rhs = new JSVector();
      rhs.parse( rhs_text );
      var r = new JSVector();
      r.copy(rhs);
      var x = new JSVector( n );

      var rank = 0;

//    document.getElementById("debug_textarea").value += "b = ";
//    for ( var i = 0; i < m; i ++ ) {
//      document.getElementById("debug_textarea").value +=
//        r.getEntry( i ) + " ";
//    }
//    document.getElementById("debug_textarea").value += "\n";

      for ( var k = 0; k < Math.min( m, n); k++) {
        R.setEntry( k, k, Blas1.ddot( m, Q.dataArray(), 1,
          Q.dataArray(), 1, k * m, k * m ) );
        var pivot = R.getEntry( k, k );
        if ( Math.abs( pivot ) <= 0 ) break;
        rank ++;
        var kp1 = k + 1;
        for ( var j = kp1; j < n; j ++ ) {
          R.setEntry( k, j, Blas1.ddot( m, Q.dataArray(), 1,
            Q.dataArray(), 1, k * m, j * m ) / R.getEntry( k, k ) );
          Blas1.daxpy( m, - R.getEntry( k, j ), Q.dataArray(), 1,
            Q.dataArray(), 1, k * m, j * m );
        }
        x.setEntry( k, Blas1.ddot( m, Q.dataArray(), 1, r.dataArray(), 1,
          k * m, 0 ) / R.getEntry( k, k ) );
        Blas1.daxpy( m, - x.getEntry( k ), Q.dataArray(), 1,
          r.dataArray(), 1, k * m, 0 );
      }
      Blas2.dtrsv( 'U', 'N', 'U', n, R.dataArray(), n, x.dataArray(),
        1, 0, 0 );

      var sq = new Array( m * n );
      var cwq = new Array( n );
      for ( var j = 0; j < rank; j ++ ) {
        cwq[ j ] = 0;
        for ( var i = 0; i < m; i ++ ) {
          sq[ i + j * m ] = scientificFormat( Q.getEntry( i, j ) );
          cwq[ j ]=Math.max( sq[ i + j * m ].length, cwq[ j ] );
        }
      }
      var sr = new Array( n * n );
      var cwr = new Array( n );
      for ( var j = 0; j < n; j ++ ) {
        cwr[ j ] = 0;
        for ( var i = 0; i <= Math.min( j, rank - 1 ); i ++ ) {
          sr[ i + j * m ] = scientificFormat( R.getEntry( i, j ) );
          cwr[ j ]=Math.max( sr[ i + j * m ].length, cwr[ j ] );
        }
      }
//    display left factor
      document.getElementById("q_factor_textarea").style.color = "green";
      document.getElementById("q_factor_textarea").value += "Q = \n";
      for ( var i = 0; i < m; i ++ ) {
        var str = new String();
        for ( var j = 0; j < rank; j ++ ) {
          var sj = sq[ i + j * m ];
          while ( sj.length < cwq[ j ] ) sj += ' ';
          str += sj + ' ';
        }
        document.getElementById("q_factor_textarea").value += str + "\n";
      }
//    display right factor
      document.getElementById("r_factor_textarea").style.color = "red";
      document.getElementById("r_factor_textarea").value += "Sigma/R = \n";
      for ( var i = 0; i < rank; i ++ ) {
        var str2 = new String();
        for ( var j = 0; j < i; j ++ ) {
          var sj2 = '';
          while ( sj2.length < cwr[ j ] ) sj2 = ' ' + sj2;
          str2 += sj2 + ' ';
        }
        for ( var j = i; j < n - 1; j ++ ) {
          sj2 = sr[ i + j * m ];
          while ( sj2.length < cwr[ j ] ) sj2 = ' ' + sj2;
          str2 += sj2 + ' ';
        }
        j = n - 1;
        sj2 = sr[ i + j * m ];
        while ( sj2.length < cwr[ j ] ) sj2= ' ' + sj2;
        str2 += sj2;
        document.getElementById("r_factor_textarea").value += str2
          + "\n";
      }
//    display x
      document.getElementById("x_textarea").style.color = "blue";
      document.getElementById("x_textarea").value += "x = \n";
      for ( var j = 0; j < n; j ++ ) {
        document.getElementById("x_textarea").value +=
          scientificFormat( x.getEntry( j ) ) + "\n";
      }
//    display r
      document.getElementById("r_textarea").style.color = "blue";
      document.getElementById("r_textarea").value += "r = \n";
      for ( var i = 0; i < m; i ++ ) {
        document.getElementById("r_textarea").value +=
          scientificFormat( r.getEntry( i ) ) + "\n";
      }
//    compute b - A * x
      document.getElementById("b_minus_Ax_textarea").value +=
        "b - A * x = \n";
      var Ax = new JSVector( m , 0 );
      Blas2.dgemv( 'N', m, n, 1, A.dataArray(), m, x.dataArray(), 1, 0,
        Ax.dataArray(), 1, 0, 0, 0 );
      for ( var i = 0; i < m; i ++ ) {
        var resid = rhs.getEntry( i ) - Ax.getEntry( i );
        document.getElementById("b_minus_Ax_textarea").value +=
          scientificFormat( resid ) + "\n";
      }
//    compute A^T * r
      document.getElementById("Atranspose_r_textarea").value +=
        "A^T * R = \n";
      var Atr = new JSVector( n , 0 );
      Blas2.dgemv( 'T', m, n, 1, A.dataArray(), m, r.dataArray(), 1, 0,
        Atr.dataArray(), 1, 0, 0, 0 );
      for ( var j = 0; j < n; j ++ ) {
        document.getElementById("Atranspose_r_textarea").value +=
          scientificFormat( Atr.getEntry( j ) ) + "\n";
      }
//    document.getElementById("debug_textarea").value +=
//      "leaving factorMatrix\n";
    }

    function scientificFormat( n ) {
      var an = Math.abs(n);
      if ( an>=0.01 && an<=100. ) return n.toString();
      else return n.toExponential();
    }
    </script>
    Enter matrix:
    <input
      type="text"
      name="matrix_text"
      value="1,1;1.e-10,0;0,1.e-10";
      size="50"
    >
    <br>
    Enter right-hand side:
    <input
      type="text"
      name="rhs_text"
      value="1;0;0";
      size="50"
    >
    <input
      type="button"
      value="Solve least squares problem"
      onclick="matrix_text=document.getElementsByName('matrix_text')[0].value;factorMatrix();"
    >
    <br>
    <textarea
      id="q_factor_textarea"
      cols=100
      rows=10
    >
    </textarea>
    <textarea
      id="r_factor_textarea"
      cols=100
      rows=10
    >
    </textarea>
    <br>
    <textarea
      id="x_textarea"
      cols=30
      rows=10
    >
    </textarea>
    <textarea
      id="r_textarea"
      cols=30
      rows=10
    >
    </textarea>
    <br>
    <textarea
      id="b_minus_Ax_textarea"
      cols=30
      rows=10
    >
    </textarea>
    <textarea
      id="Atranspose_r_textarea"
      cols=30
      rows=10
    >
    </textarea>
<!--
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=1
    >
    </textarea>
-->
    <script language="javascript"> factorMatrix(); </script>
  </BODY>
</HTML>
