<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Simulated Annealing </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script language="javascript"> 
//    function f(x) { return Math.sin( x ) - Math.cos( 2 * x ); }
      function f(x) { return ( Math.sin( x ) - Math.cos( 2 * x ) )
                             / ( 1 + .01 * x * x ); }
      var A = -10;
      var B = 10;
//    var f_min = f( - Math.atan( 1 / Math.sqrt(15) ) );
      var f_min = undefined;
      var len = B - A;
      var flen = 2.5;

      var n=2;
      var x_best = undefined;
      var f_best = Number.MAX_VALUE;
      var log10 = Math.log( 10. );

      var gt = undefined;
      var gte = undefined;
      var npts = 300;
      var xarray = new Array( npts + 1 );
      var farray = new Array( npts + 1 );
      var earray = undefined;

      function computePlotPoints( ) {
        var dx = ( B - A ) * 0.0625;
        var a = A - dx;
        var b = B + dx;
        var dx = ( b - a ) / npts;
        var fmax = f( a ); 
        var fmin = fmax; 
        xarray[ 0 ] = a;
        farray[ 0 ] = fmax;
        for ( var i = 1; i <= npts; i ++ ) {
          xarray[ i ] = xarray[ i - 1 ] + dx;
          farray[ i ] = f( xarray[ i ] );
          fmin = Math.min( fmin, farray[ i ] );
          fmax = Math.max( fmax, farray[ i ] );
        }
        return {
          flo : fmin,
          fhi : fmax
        }
      }

      function plotPoints( ) {
        gt.beginDrawing();
          gt.movePen( xarray[ 0 ], farray[ 0 ] );
          for ( var i = 1; i < xarray.length; i ++ ) {
            gt.drawLine( xarray[ i ], farray[ i ] );
          }
        gt.endDrawing();
      }

      function drawPlots() {
//      document.getElementById("debug_textarea").value +=
//        "entering drawPlots\n";
        var rel_error = Math.abs( ( f_best - f_min ) / f_min );
        document.getElementById("debug_textarea").value =
          "number annealing steps,error = " + earray.length + " "
          + rel_error + "\n";
        var fbounds = computePlotPoints( );
        gt = new XYGraphTool( document.getElementById("function_canvas"),
          "newton method", "x", "f ", A, B, fbounds.flo, fbounds.fhi );
        gt.setBgColor( "white" );
        gt.newPage();
        gt.setFgColor( "black" );
        gt.drawBoundingBox();
        gt.drawAxes();
        gt.setFgColor( "blue" );
        plotPoints( );
        gt.setFgColor( "red" );
        gt.beginDrawing();
          gt.movePen( A, f_best );
          gt.drawLine( B, f_best );
        gt.endDrawing();
        gt.setFgColor( "green" );
        gt.drawCross( x_best, f_best, ( B - A ) * 0.02 );

        ymax = earray[0];
        ymin = earray[ earray.length - 1 ];
//      document.getElementById("debug_textarea").value +=
//        "ymin,ymax = " + ymin + " " + ymax + "\n";
        var cnvs = document.getElementById("error_canvas");
        var gte = new XYGraphTool( cnvs, "log (relative error) vs log n",
          "log_10(n)","log_10(relative error in min)",
          0, Math.log( earray.length ) / log10, ymin, ymax );
        gte.setBgColor( "white" );
        gte.newPage();
        gte.setFgColor( "black" );
        gte.drawAxes();
        gte.setFgColor( "blue" );
        gte.beginDrawing();
          gte.movePen(0,earray[0]);
          for (var i = 1; i < earray.length; i++ ) {
            gte.drawLine( Math.log( i + 1 ) / log10, earray[ i ] );
          }
        gte.endDrawing();
//      document.getElementById("debug_textarea").value +=
//        "leaving drawPlots\n";
      }

      function goldenSearch( xa, xb ) {
        var fa = f( xa );
        var fb = f( xb );
        var tau = 2 / ( 1 + Math.sqrt( 5 ) );
        var h = xb - xa;
        var xc = xa + tau * h;
        var xd = xb - tau * h;
        var fc = f(xc);
        var fd = f(xd);
        while ( true ) {
          if ( fd > fc ) {
            xa = xd;
            fa = fd;
            xd = xc;
            fd = fc;
            xc = xa + tau * ( xb - xa );
            fc = f( xc );
            if ( fc >= Math.max( fa, fb ) ) return .5 * ( xc + xd );
          } else {
            xb = xc;
            fb = fc;
            xc = xd;
            fc = fd;
            xd = xb - tau * ( xb - xa );
            fd = f( xd );
            if ( fd >= Math.max( fa, fb ) ) return .5 * ( xc + xd );
          }
        }
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        var x_min = goldenSearch( -.5, 0. );
        f_min = f( x_min );
        n = 2;
        simulatedAnnealing();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function simulatedAnnealing() {
//      document.getElementById("debug_textarea").value +=
//        "entering simulatedAnnealing\n";
        var x = 10;
        var fx = f( x );
        x_best = x;
        f_best = fx;
        earray = new Array();
        for ( var i = 0; i < n; i ++ ) {
          var temperature = 1. / ( 1 + i );
          var xnew = Math.max( A, Math.min( B,
            x + len * ( Math.random() - 0.5 ) ) );
          var fnew = f( xnew );
//        document.getElementById("debug_textarea").value +=
//          "xnew,fnew = " + xnew + " " + fnew + "\n";
          var df = ( fx - fnew ) / flen;
          var dx = ( xnew - x ) / len;
          if ( df > 0 ) {
            x = xnew;
            fx = fnew;
          } else if ( Math.exp( -df / temperature ) > Math.random() ) {
            x = xnew;
            fx = fnew;
          }
          if ( fnew < f_best ) {
            x_best = xnew;
            f_best = fnew;
          }
          earray.push( Math.log( Math.max( 1.e-16, f_best - f_min ) )
                     / log10 );
        }
        drawPlots();
        
        n *= 2;
//      document.getElementById("debug_textarea").value +=
//        "leaving simulatedAnnealing\n";
      }
    </script>
  </HEAD>
  <BODY>
    <h2>
      Simulated Annealing to minimize
      \( \frac{ \sin(x) - \cos(2 x) }{ 1 + ( x / 10 )^2 } \;\text{on}\;
      (-10,10) \)
    </h2>
    <br>
    <canvas id="function_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="error_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    <input
      type="button"
      value="double the sample size"
      onclick="simulatedAnnealing();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=3
    >
    </textarea>
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
<html><head></head><body></body></html>
