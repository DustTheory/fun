<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Hermite Cubic Interpolation Method </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
  </HEAD>
  <BODY>
    <h2>
      Hermite cubic interpolation to find a minimum of
        \( f(x) = (1-x)^{10}-x^2 \)
    </h2>
    <script src=../plotting/XYGraphTool.js></script>
    <script language="javascript">
      var log10 = Math.log( 10. );
      var npts = 300;
      var soln = undefined;
      var fa = undefined;
      var fpa = undefined;
      var fb = undefined;
      var fpb = undefined;
      var gt = undefined;
      var xarray = new Array( npts + 1 );
      var farray = new Array( npts + 1 );
      var earray = new Array();

//    var A = -10;
//    var B = 10;
//    function f( x ) { return -8+x*x*(3+x*(-4+x)); }
//    function fp( x ) { return x*(6+x*(-12+4*x)); }

//    var A = -30;
//    var B = 2;
//    function f( x ) { return Math.exp(x)-1.5-Math.atan(x); }
//    function fp( x ) { return Math.exp(x)-1/(1+x*x); }

      var A = -8;
      var B = 10;
      function f( x ) { return Math.pow(1-x,10)-x*x; }
      function fp( x ) { return -10*Math.pow(1-x,9)-2*x; }

//    var A = 2;
//    var B = 7.5;
//    function f( x ) { return Math.sin(x)-Math.cos(2*x); }
//    function fp( x ) { return Math.cos(x)+2*Math.sin(2*x); }

      function computePlotPoints( ) {
        var dx = ( B - A ) * 0.0625;
        var a = A - dx;
        var b = B + dx;
        var dx = ( b - a ) / npts;
        var fmax = f( a ); 
        var fmin = fmax; 
        xarray[ 0 ] = a;
        farray[ 0 ] = fmax;
        for ( var i = 1; i <= npts; i ++ ) {
          xarray[ i ] = xarray[ i - 1 ] + dx;
          farray[ i ] = f( xarray[ i ] );
          fmin = Math.min( fmin, farray[ i ] );
          fmax = Math.max( fmax, farray[ i ] );
        }
        return {
          flo : fmin,
          fhi : fmax
        }
      }

      function plotPoints( ) {
        gt.beginDrawing();
          gt.movePen( xarray[ 0 ], farray[ 0 ] );
          for ( var i = 1; i < xarray.length; i ++ ) {
            gt.drawLine( xarray[ i ], farray[ i ] );
          }
        gt.endDrawing();
      }

      function plotHermiteCubic( x0, fx0, fpx0, x1, fx1, fpx1 ) {
//      document.getElementById("debug_textarea").value +=
//        "entering plotHermiteCubic\";
        var dx = ( gt.user_xhi - gt.user_xlo ) / npts;
        var currently_drawing = false;
        gt.beginDrawing();
          var x = gt.user_xlo;
          for ( var i = 0; i <= npts; i++, x += dx ) {
            var h = x1 - x0;
            var xi = ( x - x0 ) / h;
            var y = Math.pow( 1 - xi, 2 )
                  * ( fx0 * ( 2 * x + x1 - 3 * x0 ) / h + fpx0 * xi * h )
              + Math.pow( xi, 2 )
                * ( fx1 * ( 3 * x1 - 2 * x - x0 ) / h - fpx1 * ( x1 - x ) );
            if ( y >= gt.user_ylo && y <= gt.user_yhi ) {
              if ( currently_drawing ) gt.drawLine( x, y );
              else {
                gt.movePen(x,y);
                currently_drawing = true;
              }
            } else currently_drawing = false;
          }
        gt.endDrawing();
//      document.getElementById("debug_textarea").value +=
//        "leaving plotHermiteCubic\";
      }

      function plotError( ) {
//      document.getElementById("debug_textarea").value +=
//        "entering plotError\n";
        var ymin = Number.MAX_VALUE;
        var ymax = -Number.MAX_VALUE;
        for ( var i = 0; i < earray.length; i ++ ) {
          ymin = Math.min( ymin, earray[ i ] ); 
          ymax = Math.max( ymax, earray[ i ] ); 
        }
        gte = new XYGraphTool( document.getElementById("error_canvas"),
          "function value vs iteration", "iteration number", "abs(f(x)) ",
          0, earray.length - 1, ymin, ymax );
        gte.setBgColor( "white" );
        gte.newPage();
        gte.setFgColor( "black" );
        gte.drawBoundingBox();
        gte.drawAxes();
        gte.setFgColor( "red" );
        gte.beginDrawing();
          gte.movePen( 0, earray[ 0 ] );
          for ( var i = 1; i < earray.length; i ++ ) {
            gte.drawLine( i, earray[ i ] );
          }
        gte.endDrawing();
//      document.getElementById("debug_textarea").value +=
//        "leaving plotError\n";
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        earray = new Array();
        var fbounds = computePlotPoints( );
        gt = new XYGraphTool( document.getElementById("hermite_canvas"),
          "hermite method", "x", "f ", A, B, fbounds.flo, fbounds.fhi );
        gt.setBgColor( "white" );
        gt.newPage();
        gt.setFgColor( "black" );
        gt.drawBoundingBox();
        gt.drawAxes();
        gt.setFgColor( "blue" );
        plotPoints( );
        fa = f( A );
        fpa = fp( A );
        fb = f( B );
        fpb = fp( B );
        hermiteIteration()
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function hermiteIteration() {
//      document.getElementById("debug_textarea").value +=
//        "entering hermiteIteration\n";
        document.getElementById("debug_textarea").value =
          "A,fa,fpa = " + A + " " + fa + " " + fpa + "\n";
        document.getElementById("debug_textarea").value +=
          "B,fb,fpb = " + B + " " + fb + " " + fpb + "\n";
//      if ( B <= A ) {
//        document.getElementById("debug_textarea").value =
//          "A = B = " + A + "\n";
//        return;
//      }
        if ( fpa >= 0 ) {
          document.getElementById("debug_textarea").value =
            "f'(A = " + A + ") >= 0\n";
          return;
        }
        if ( fpb <= 0 ) {
          document.getElementById("debug_textarea").value =
            "f'(B = " + B + ") >= 0\n";
          return;
        }
        gt.setBgColor( "white" );
        gt.newPage();
        gt.setFgColor( "black" );
        gt.drawBoundingBox();
        gt.drawAxes();
        gt.setFgColor( "blue" );
        plotPoints( );
        gt.setFgColor( "green" );
        plotHermiteCubic( A, fa, fpa, B, fb, fpb );

        var delta = 6 * ( fb - fa ) / ( B - A );
        var delta2 = 3 * ( fpb + fpa ) - delta;
        var delta1 = 2 * fpb + 4 * fpa - delta;
        var disc = delta1 * delta1 - 4 * delta2 * fpa
        var root1 = ( delta1 < 0 ?
          2 * fpa / ( delta1 - Math.sqrt( disc ) ) :
          0.5 * ( delta1 + Math.sqrt( disc ) ) / delta2 );
        var root2 = fpa / ( delta2 * root1 );
        soln = A + ( B - A ) * ( root1 > 0 && root1 < 1 ? root1 : root2 );
        if ( soln <= A || soln >= B ) {
          document.getElementById("debug_textarea").value =
            "unable to approximate local min between A = " + A + "and B = "
            + B + "\n";
          return;
        }
        var fsoln = f( soln );
        var fpsoln = fp( soln );
        gt.drawCross( soln, fsoln, ( B - A ) * .02 );
        if ( fsoln == 0 ) {
          document.getElementById("debug_textarea").value =
            "f'(soln = " + soln + ") = 0\n";
          return;
        }

        if ( fpsoln < 0 ) {
          A = soln;
          fa = fsoln;
          fpa = fpsoln;
        } else {
          B = soln;
          fb = fsoln;
          fpb = fpsoln;
        }
        var fbounds = computePlotPoints( );
        gt.rescale( A, B, fbounds.flo, fbounds.fhi );

        earray.push( Math.log( Math.max( 1.e-16, Math.abs( fp(soln) ) ) )
                   / log10 );
        plotError();
//      document.getElementById("debug_textarea").value +=
//        "leaving hermiteIteration\n";
      }
    </script>
    <br>
    <canvas id="hermite_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="error_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    <input
      type="button"
      value="Perform another iteration"
      onclick="hermiteIteration();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=3
    >
    </textarea>
    <script language="javascript"> XYGraphTool.onload("hermite_canvas");onStart(); </script>
  </BODY>
</HTML>
