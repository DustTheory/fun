<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Fibonacci search </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
  </HEAD>
  <BODY>
    <h2>
      Fibonacci search to find a minimum of a unimodal function
    </h2>
    <script src=../computer/numberToHexadecimal.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script language="javascript">
      function f( x ) { 
        return 1 - 2 * Math.exp( - Math.abs( x + 2 * (x-5) ) );
      }

      var canvas = undefined;
      var A = 0;
      var B = 6;
      var a = undefined;
      var b = undefined;
      var tol = 0.25;
      var fib = new Array();
      var c = undefined;
      var d = undefined;
      var fa = undefined;
      var fb = undefined;
      var fc = undefined;
      var fd = undefined;
      var n = 0;
      var npts = 300;
      var xarray = new Array( npts + 1 );
      var farray = new Array( npts + 1 );
      var i = 0;
      var gt = undefined;

      function computePlotPoints( ) {
        var dx = ( b - a ) * 0.0625;
        var xlo = a - dx;
        var xhi = b + dx;
        var dx = ( xhi - xlo ) / npts;
        var fmax = f( xlo ); 
        var fmin = fmax; 
        xarray[ 0 ] = xlo;
        farray[ 0 ] = fmax;
        for ( var i = 1; i <= npts; i ++ ) {
          xarray[ i ] = xarray[ i - 1 ] + dx;
          farray[ i ] = f( xarray[ i ] );
          fmin = Math.min( fmin, farray[ i ] );
          fmax = Math.max( fmax, farray[ i ] );
        }
        return {
          flo : fmin,
          fhi : fmax
        }
      }

      function plotPoints( ) {
        gt.beginDrawing();
          gt.movePen( xarray[ 0 ], farray[ 0 ] );
          for ( var i = 1; i < xarray.length; i ++ ) {
            gt.drawLine( xarray[ i ], farray[ i ] );
          }
        gt.endDrawing();
      }

      function drawPlot( ) {
        var bounds = computePlotPoints();
        gt = new XYGraphTool( canvas,
          "Fibonacci search", "x", "f ", a, b, bounds.flo, bounds.fhi );
        gt.setBgColor( "white" );
        gt.newPage();
        gt.setFgColor( "black" );
        gt.drawBoundingBox();
        gt.drawAxes();
        gt.setFgColor( "blue" );
        plotPoints( );
        gt.setFgColor( "red" );
        gt.drawCross( a, fa, ( b - a ) * 0.02 );
        gt.drawCross( b, fb, ( b - a ) * 0.02 );
        gt.drawCross( c, fc, ( b - a ) * 0.02 );
        gt.drawCross( d, fd, ( b - a ) * 0.02 );
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        canvas = document.getElementById("fibonacci_search_canvas");
        tol=document.getElementsByName('tol')[0].value;
        a = A;
        b = B;
        var m = Math.ceil( ( b - a ) / tol );
        fib = new Array();
        fib[ 0 ] = 0;
        fib[ 1 ] = 1;
        n = 1;
        while ( fib[ n ] < m ) {
          n ++;
          fib[ n ] = fib[ n - 1 ] + fib[ n - 2 ];
        }
//      document.getElementById("debug_textarea").value +=
//        "tol = " + tol + " fib = ";
//      for ( var j = 0; j <= n; j ++ ) {
//        document.getElementById("debug_textarea").value +=
//          fib[ j ] + " ";
//      }
//      document.getElementById("debug_textarea").value += "\n";

        var h = ( b - a ) * fib[ n - 1 ] / fib[ n ];
//      document.getElementById("debug_textarea").value +=
//        "h = " + h + "\n";
        c = a + h;
        d = b - h;

        fa = f(a);
        fb = f(b);
        fc = f(c);
        fd = f(d);
        i = 1;
        document.getElementById("debug_textarea").value =
          "  a,d,c,b = " + a + " " + d + " " + c + " " + b + "\n";
//      document.getElementById("debug_textarea").value +=
//        "  fa,fd,fc,fb = " + fa + " " + fd + " " + fc + " " + fb + "\n";
        if ( Math.max( fc, fd ) >= Math.max( fa, fb ) ) {
          document.getElementById("debug_textarea").value =
            "function not unimodal\n";
          return;
        }
        drawPlot( );
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function fibonacciSearch() {
//      document.getElementById("debug_textarea").value +=
//        "entering fibonacciSearch\n";
        if ( i + 2 >= n ) {
          var h = c - a;
          document.getElementById("debug_textarea").value =
            "desired tolerance reached: c - a = b - d = " + h + "\n";
          return;
        }
        if ( fd > fc ) {
//        document.getElementById("debug_textarea").value +=
//          "  fd > fc\n";
          a = d;
          fa = fd;
          d = c;
          fd = fc;
          var h = ( b - a ) * fib[ n - i - 1 ] / fib[ n - i ];
//        document.getElementById("debug_textarea").value +=
//          "h = " + h + "\n";
          c = a + h;
          fc = f(c);
          if ( fc >= Math.max( fa, fb ) ) {
            document.getElementById("debug_textarea").value =
              "function not unimodal\n";
            return;
          }
        } else {
//        document.getElementById("debug_textarea").value +=
//          "  fd <= fc\n";
          b = c;
          fb = fc;
          c = d;
          fc = fd;
          var h = ( b - a ) * fib[ n - i - 1 ] / fib[ n - i ];
//        document.getElementById("debug_textarea").value +=
//          "h = " + h + "\n";
          d = b - h;
          fd = f(d);
          if ( fd >= Math.max( fa, fb ) ) {
            document.getElementById("debug_textarea").value +=
              "function not unimodal\n";
            return;
          }
        }
        i ++;
//      var h = b - a;
//      document.getElementById("debug_textarea").value +=
//        "  b - a = " + h + "\n";
        document.getElementById("debug_textarea").value =
          "  a,d,c,b = " + a + " " + d + " " + c + " " + b + "\n";
//      document.getElementById("debug_textarea").value +=
//        "  fa,fd,fc,fb = " + fa + " " + fd + " " + fc + " " + fb + "\n";
        drawPlot( );
//      document.getElementById("debug_textarea").value +=
//        "leaving fibonacciSearch\n";
      }
      function checkNumber(n) {
        if (!isFinite(n)) {
          alert("entered value is not a NUMBER");
          return false;
        }
        return true;
      }
    </script>
    <canvas id="fibonacci_search_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    tolerance:
    <input
      type="number"
      name="tol"
      value="0.25"
      onchange="checkNumber(document.getElementsByName('tol')[0].value);
        onStart();"
      size=20
    >
    <br>
    <input
      type="button"
      value="Perform another Fibonacci search iteration"
      onclick="fibonacciSearch();"
    >
    <br>
    <input
      type="button"
      value="Start over"
      onclick="onStart();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=5
    >
    </textarea>
    <script language="javascript"> XYGraphTool.onload("fibonacci_search_canvas");onStart(); </script>
  </BODY>
</HTML>
