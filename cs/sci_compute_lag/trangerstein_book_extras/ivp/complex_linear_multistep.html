<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE>Linear Multistep Methods</TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
  </HEAD>
  <BODY>
    linear multistep methods to solve
    $$y^\prime(t) = \lambda y(t), y(0) = 1$$
    <br>
    <script src=../plotting/XYGraphTool.js></script>
    <script src=../linear_algebra/Complex.js></script>
    <script language="javascript">
      var rate=new Complex(1.,0.);

      var order=1;
      var coarse_number_steps = 1;
      var number_refinements=0;
      var scheme = 0;
      // Adams-Bashforth:0, Adams-Moulton:1, BDF:2, Explicit-midpoint:3

      var lm_gamma=new Array(10);
      var newton_tolerance=1.e-15;
      var maxit=5;
      var tstop=1.;
      var y_init=new Complex(1.,0.);
      var y = new Complex(Number.MAX_VALUE,Number.MAX_VALUE);
      var yold = new Complex(Number.MAX_VALUE,Number.MAX_VALUE);
      var ratio=2;

      var k = 0; // refinement number
      var n = 1; // number of timesteps in current refinement
      var step=0;
      var ftable;
      var ftable_old;
//    var ytable;
//    var ytable_old;
      var log_error = Array(1);
      var log_n = Array(1);
      var emax = - Number.MAX_VALUE;
      var emin = Number.MAX_VALUE;
      var tmax = - Number.MAX_VALUE;
      var tmin = Number.MAX_VALUE;
      var ymax = new Complex( - Number.MAX_VALUE, - Number.MAX_VALUE );
      var ymin = new Complex( Number.MAX_VALUE, Number.MAX_VALUE );
      var tarray;
      var yarray;
      var gt;
      var gte;
      var log10 = Math.log( 10. );

      function f( y, t ) { return ComplexMath.times( rate , y ); }
      function dfdy( y, t ) { return rate; }
      function exact( t ) { return ComplexMath.times( y_init ,
        ComplexMath.exp( ComplexMath.timesNumber( rate , t ) ) ); }
      function adamsBashforthStartup() {
        for ( var i = 0; i < order; i ++ ) {
          lm_gamma[ i ] = 1.;
          for ( var j = 0; j < i; j ++ ) {
            lm_gamma[ i ]  -= lm_gamma[ j ] * 1. / ( i - j + 1 );
          }
        }
      }
      function adamsBashforth( dt, t, ftable ) {
//      document.getElementById("debug_textarea").value +=
//        "entering adamsBashforth\n";
        var fold = new Complex();
        fold.setValue( f(y,t) );
//      document.getElementById("debug_textarea").value +=
//        "dt,t,y,f = " + dt + " " + t + " (" + y.getReal() + ","
//        + y.getImag() + ") (" + fold.getReal() + "," + fold.getImag()
//        + ")\n";
        var temp = new Complex();
        temp.setValue( ftable[ order - 1 ] );
        ftable[ order - 1 ].setValue( fold );
        var sumf = new Complex();
        sumf.setValue( fold );
        for ( var i = 1; i <= Math.min( step, order - 1 ); i ++ ) {
          fold.setValue( ComplexMath.minus( ftable[ order - i ] , temp ) );
          temp.setValue( ftable[ order- 1 - i ] );
          ftable[ order - 1 - i ].setValue( fold );
          sumf.plusEquals( ComplexMath.timesNumber( fold, lm_gamma[ i ] ) );
        }
        y.plusEquals( ComplexMath.timesNumber( sumf, dt ) );
//      document.getElementById("debug_textarea").value +=
//        "ynew = (" + y.getReal() + "," + y.getImag() + ")\n";
//      document.getElementById("debug_textarea").value +=
//        "leaving adamsBashforth\n";
      }
      function adamsMoultonStartup() {
//      document.getElementById("debug_textarea").value +=
//        "entering adamsMoultonStartup\n";
        lm_gamma[ 0 ] = 1.;
        for ( var i = 1; i < order; i ++ ) {
          lm_gamma[ i ] = 0.;
          for ( var j = 0; j < i; j ++ ) {
            lm_gamma[ i ]  -= lm_gamma[ j ] * 1. / ( i - j + 1 );
          }
        }

//      for ( var i = 0; i < order; i ++ ) {
//        document.getElementById("debug_textarea").value +=
//          "lm_gamma[ " + i + " ] = " + lm_gamma[ i ] + "\n";
//      }
//      document.getElementById("debug_textarea").value +=
//        "leaving adamsMoultonStartup\n";
      }
      function adamsMoulton( dt, t, ftable, ftable_old ) {
//      document.getElementById("debug_textarea").value +=
//        "entering adamsMoulton\n";
//      document.getElementById("debug_textarea").value +=
//        "dt,t,y = " + dt + " " + t + " " + y + "\n";
//      for ( var i = 0; i < order; i ++ ) {
//        document.getElementById("debug_textarea").value +=
//          "ftable[ " + i + " ] = " + ftable[ i ] + "\n";
//      }
        var sum_gamma = 0.;
        for ( var i = 0; i < order; i ++ ) {
          ftable_old[ order -1 - i ] = new Complex( 0., 0.);
        }
        for ( var i = 0; i <= Math.min( step, order - 1 ); i ++ ) {
          ftable_old[ order -1 - i ].setValue( ftable[ order -1 - i ] );
          sum_gamma += lm_gamma[ i ];
        }
        for ( var i = 0; i < order; i ++ ) ftable[ i ] = new Complex();

//      for ( var i = 0; i < order; i ++ ) {
//        document.getElementById("debug_textarea").value +=
//          "ftable_old[ " + i + " ] = " + ftable_old[ i ] + "\n";
//      }
//      document.getElementById("debug_textarea").value +=
//        "sum_gamma = " + sum_gamma + "\n";

        sum_gamma *= dt;
        var converged = false;
        var ynew = new Complex();
        ynew.setValue( y );
        var it = 0;
        while ( ! converged && it <= maxit ) {
          var fnew = new Complex();
          fnew.setValue( f( ynew, t + dt ) );
          var temp = new Complex();
          temp.setValue( ftable_old[ order - 1 ] );
          ftable[ order - 1 ] = new Complex();
          ftable[ order - 1 ].setValue( fnew );
          var sumf = new Complex();
          sumf.setValue( fnew );

//        document.getElementById("debug_textarea").value +=
//          "\nit = " + it + "\n";
//        document.getElementById("debug_textarea").value +=
//          "fnew,temp,sumf = " + fnew + " " + temp + " " + sumf + "\n";

          for ( var i = 1; i <= Math.min( step, order - 1 ); i ++ ) {
            fnew.setValue( ComplexMath.minus( ftable[ order - i ] , temp ));
            temp.setValue( ftable_old[ order - 1 - i ] );
            ftable[ order- 1 - i ] = new Complex();
            ftable[ order- 1 - i ].setValue( fnew );
            sumf.plusEquals( ComplexMath.timesNumber(
              ftable[ order - 1 - i ] , lm_gamma[ i ] ) );
//          document.getElementById("debug_textarea").value +=
//            "fnew,temp,sumf = " + fnew + " " + temp + " " + sumf
//            + "\n";
          }

//        for ( var i = 0; i < order; i ++ ) {
//          document.getElementById("debug_textarea").value +=
//            "ftable[ " + i + " ] = " + ftable[ i ] + "\n";
//        }

          var fmoulton = new Complex();
          fmoulton.setValue( ComplexMath.minus(
            ComplexMath.minus( ynew , y ) ,
            ComplexMath.timesNumber( sumf, dt ) ) );
          converged = ComplexMath.abs( fmoulton ) <= newton_tolerance
            * Math.max( ComplexMath.abs( ynew ),
                        dt * ComplexMath.abs( ftable[ order - 1 ] ) );
          var dfmoultondy = new Complex( 1., 0. );
          dfmoultondy.minusEquals( ComplexMath.timesNumber(
            dfdy( ynew, t + dt ), sum_gamma ) );
          ynew.minusEquals( ComplexMath.divide( fmoulton , dfmoultondy ) );

//        document.getElementById("debug_textarea").value +=
//          "fmoulton,converged,dfmoultondy,ynew " + fmoulton + " "
//          + converged + " " + dfmoultondy + " " + ynew + "\n";

          it ++;
        }
        y = ynew;
//      document.getElementById("debug_textarea").value +=
//        "leaving adamsMoulton\n";
      }
      function bdfStartup() {
//      document.getElementById("debug_textarea").value +=
//        "entering bdfStartup\n";
        lm_gamma[ 0 ] = 0.;
        for ( var i = 1; i <= order; i ++ ) {
          lm_gamma[ i ] = 1. / i;
        }
//      document.getElementById("debug_textarea").value +=
//        "leaving bdfStartup\n";
      }
      function bdf( dt, t, ytable, ytable_old ) {
//      document.getElementById("debug_textarea").value +=
//        "entering bdf\n";
//      document.getElementById("debug_textarea").value +=
//        "step,dt,t = " + step + " " + dt + " " + t + "\n";
//      for ( var i = 0; i <= order; i ++ ) {
//        document.getElementById("debug_textarea").value +=
//          "ytable[ " + i + " ] = " + ytable[ i ] + "\n";
//      }
        var sum_gamma = 0.;

        for ( var i = 0; i <= order; i ++ ) {
          ytable_old[ i ] = new Complex( 0., 0.);
        }
        for ( var i = 0; i <= Math.min( step, order ); i ++ ) {
          ytable_old[ order - i ].setValue( ytable[ order - i ] );
          sum_gamma += lm_gamma[ i ];
        }
        for ( var i = 0; i <= order; i ++ ) ytable[ i ] = new Complex();
//      for ( var i = 0; i <= order; i ++ ) {
//        document.getElementById("debug_textarea").value +=
//          "ytable_old[ " + i + " ] = " + ytable_old[ i ] + "\n";
//      }
        var converged = false;
        var ynew = new Complex();
        ynew.setValue( y );
        var it = 0;
//      document.getElementById("debug_textarea").value +=
//        "it,ynew = " + it + " " + ynew + "\n";
        while ( ! converged && it <= maxit ) {
          var fnew = new Complex();
          fnew.setValue( f( ynew, t + dt ) );
          var temp = new Complex();
          temp.setValue( ytable_old[ order ] );
          ytable[ order ] = new Complex();
          ytable[ order ].setValue( ynew );
//        document.getElementById("debug_textarea").value +=
//          "fnew,temp,ytable[" + order + "] = " + fnew + " " + temp + " "
//          + ytable[order] + "\n";
          var sumy = new Complex( 0., 0. );
          for ( var i = 1; i <= Math.min( step, order ); i ++ ) {
            var ytnew = new Complex();
            ytnew.setValue( ComplexMath.minus( ytable[ order + 1 - i ] ,
              temp ) );
            temp.setValue( ytable_old[ order - i ] );
//          document.getElementById("debug_textarea").value +=
//            "i,ytnew,temp = " + i + " " + ytnew + " " + temp + "\n";
            ytable[ order - i ] = new Complex();
            ytable[ order - i ].setValue( ytnew );
            sumy.plusEquals( ComplexMath.timesNumber( ytable[ order - i ] ,
              lm_gamma[ i ] ) );
//          document.getElementById("debug_textarea").value +=
//            "ytable[" + order-i + "],sumy = " + ytable[order-i] + " "
//            + sumy + "\n";
          }
          var fbdf = ComplexMath.minus( sumy,
            ComplexMath.timesNumber( fnew , dt ) );
          converged = ComplexMath.abs( fbdf ) <= newton_tolerance
            * Math.max( ComplexMath.abs( ynew ),
                        dt * ComplexMath.abs( fnew ) );
          var dfbdfdy = new Complex( sum_gamma , 0. ); 
          dfbdfdy.minusEquals( 
            ComplexMath.timesNumber( dfdy( ynew, t + dt ) , dt ) );
          ynew.minusEquals( ComplexMath.divide( fbdf , dfbdfdy ) );
//        document.getElementById("debug_textarea").value +=
//          "fbdf,converged,dfbdfdy,ynew = " + fbdf + " " + converged + " "
//          + dfbdfdy + " " + ynew + "\n";
          it ++;
        }
        y.setValue( ynew );
//      document.getElementById("debug_textarea").value +=
//        "leaving bdf\n";
      }
      function explicitMidpoint( dt, t ) {
//      document.getElementById("debug_textarea").value +=
//        "entering explicitMidpoint\n";
//      document.getElementById("debug_textarea").value +=
//        "t,dt,yold,y = " + t + " " + dt + " " + yold + " " + y + "\n";
        var ynew = ComplexMath.plus( yold ,
          ComplexMath.timesNumber( f( y, t ) , 2. * dt ) );
        yold.setValue( y );
        y.setValue( ynew );
//      document.getElementById("debug_textarea").value +=
//        "yold,y = " + yold + " " + y + "\n";
//      document.getElementById("debug_textarea").value +=
//        "leaving explicitMidpoint\n";
      }
      function integrate() {
//      document.getElementById("debug_textarea").value +=
//        "entering integrate\n";
        t = 0;
        y = new Complex();
        y.setValue( y_init );
        dt = tstop / n;
        tmin = t;
        tmax = t;
        ymin.setValue( y_init );
        ymax.setValue( y_init );
        tarray = new Array( n + 1 );
        yarray = new Array( n + 1 );
        tarray[ 0 ] = t;
        yarray[ 0 ] = new Complex();
        yarray[ 0 ].setValue( y_init );
        yold.setValue( exact( t - dt ) );
        if ( scheme == 1 ) { // Adams-Moulton
          ftable[ order - 1 ] = new Complex();
          ftable[ order - 1 ].setValue( f( y, t ) );
        } else if ( scheme == 2 ) { // BDF
          ftable[ order ] = new Complex();
          ftable[ order ].setValue( y );
        }
//      document.getElementById("debug_textarea").value +=
//        "yarray[ 0 ] = " + " (" + yarray[0].getReal() + ","
//        + yarray[0].getImag() + ")\n";
        for ( step = 0; step < n; step ++, t += dt ) {
          switch ( scheme ) {
            case 1: // Adams-Moulton
              adamsMoulton( dt, t, ftable, ftable_old );
              break;
            case 2: // BDF
              bdf( dt, t, ftable, ftable_old );
              break;
            case 3: // explicit midpoint
              explicitMidpoint( dt, t );
              break;
            default: // Adams-Bashforth
              adamsBashforth( dt, t, ftable );
              break;
          }
          if ( step <= order && ( scheme != 3 ) ) {
//          cheat during startup to get correct order
            y = exact( t + dt );
//          document.getElementById("debug_textarea").value +=
//            "exact = " + y + "\n";
            switch ( scheme ) {
              case 1: // Adams-Moulton
                var fnew = new Complex();
                fnew.setValue( f( y, t + dt ) );
                ftable[ order - 1 ].setValue( fnew );
                var temp = new Complex();
                temp.setValue( ftable_old[ order - 1 ] );
//              document.getElementById("debug_textarea").value +=
//                "i,fnew = 0 " + fnew + "\n";
//              document.getElementById("debug_textarea").value +=
//                "step = " + step + "\n";
                for ( var i = 1; i < step; i ++ ) {
//                document.getElementById("debug_textarea").value +=
//                  "i,order = " + i + " " + order + "\n";
//                document.getElementById("debug_textarea").value +=
//                  "temp,ftable = " + temp + " " + ftable[ order - i ]
//                  + "\n";
                  fnew = ComplexMath.minus( ftable[ order - i ] , temp );
                  temp.setValue( ftable_old[ order - 1 - i ] );
//                document.getElementById("debug_textarea").value +=
//                  "fnew,temp = " + fnew + " " + temp + "\n";
                  ftable[ order - 1 - i ].setValue( fnew );
//                document.getElementById("debug_textarea").value +=
//                  "i,fnew = " + i + " " + fnew + "\n";
                }
//              document.getElementById("debug_textarea").value +=
//                "step,t,f,y = " + step + " " + t + " " + fnew + " " + y
//                + "\n";
                break;
              case 2: // BDF
                var temp = new Complex();
                temp.setValue( ftable_old[ order ] );
                ftable[ order ].setValue( y );
                for ( var i = 1; i <= step; i ++ ) {
                  var ytnew = ComplexMath.minus( ftable[ order + 1 - i ] ,
                    temp );
                  temp.setValue( ftable_old[ order - i ] );
                  ftable[ order - i ].setValue( ytnew );
                }
                break;
            }
          }
          if ( scheme == 3 && step == n - 1 ) {
//          smoothing operation
            y = ComplexMath.timesNumber( ComplexMath.plus(
              ComplexMath.plus( y , yold ) ,
              ComplexMath.timesNumber( f( y, t + dt ) , dt ) ) , 0.5 );
          }
          tarray[ step + 1 ] = t + dt;
          yarray[ step + 1 ] = new Complex();
          yarray[ step + 1 ].setValue( y );
          ymin = new Complex( Math.min( ymin.getReal(), y.getReal() ),
            Math.min( ymin.getImag(), y.getImag() ) );
          ymax = new Complex( Math.max( ymax.getReal(), y.getReal() ),
            Math.max( ymax.getImag(), y.getImag() ) );
          var tt = t + dt;
          var ss = step + 1;
//        document.getElementById("debug_textarea").value +=
//          "yarray[ " + ss + " ] = (" + yarray[ss].getReal()
//          + "," + yarray[ss].getImag() + ")\n";
        }

        gt = new XYGraphTool( plot_canvas, "y(t)", "real part",
          "imaginary part", ymin.getReal(), ymax.getReal(),
          ymin.getImag(), ymax.getImag() );
        gt.setBgColor("white");
        gt.newPage();
        gt.setFgColor("black");
        gt.drawAxes();
        gt.setFgColor("blue");
        gt.beginDrawing();
          gt.movePen( yarray[ 0 ].getReal(), yarray[ 0 ].getImag() );
          for ( var j = 1; j <= n; j ++ ) {
            gt.drawLine( yarray[ j ].getReal(), yarray[ j ].getImag() );
          }
        gt.endDrawing();
        gt.setFgColor("red");
        gt.beginDrawing();
          var yexact = exact( tarray[ 0 ] );
          gt.movePen( yexact.getReal(), yexact.getImag() );
          for ( var j = 1; j <= n; j ++ ) {
            yexact = exact( tarray[ j ] );
            gt.drawLine( yexact.getReal(), yexact.getImag() );
          }
        gt.endDrawing();
        var answer = exact( tarray[ n ] );
        var error = ComplexMath.abs( ComplexMath.minus( answer ,
          yarray[ n ] ) );
        if ( error <= 0 ) error = ComplexMath.abs( answer ) * 1.e-16;
        log_error[ k ] = Math.log( error ) / log10;
        log_n[ k ] = Math.log( n ) / log10;
        emax = Math.max( emax, log_error[ k ] );
        emin = Math.min( emin, log_error[ k ] );

        if ( k > 0 ) {
          gte = new XYGraphTool( error_canvas, "log(error) vs log(n)",
            "log(n)", "log(error)", log_n[0], log_n[k], emin, emax );
          gte.setBgColor("white");
          gte.newPage();
          gte.setFgColor("black");
          gte.drawAxes();
          gte.setFgColor("blue");
          gte.beginDrawing();
            gte.movePen( log_n[ 0 ], log_error[ 0 ] );
            for ( var j = 1; j <= k; j ++ ) {
              gte.drawLine( log_n[ j ], log_error[ j ] );
            }
          gte.endDrawing();
        }
        k ++;
//      document.getElementById("debug_textarea").value +=
//        "leaving integrate\n";
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        var radio_buttons =
          document.getElementsByName("scheme_radiobox");
        for ( var i = 0; i < radio_buttons.length; i ++ ) {
          if ( radio_buttons[ i ].checked ) {
            scheme = Number( radio_buttons[ i ].value );
            break;
          }
        }
        rate = new Complex(
          document.getElementById('rate_real_textarea').value,
          document.getElementById('rate_imag_textarea').value );
        order = Number( document.getElementById('order_textarea').value );
        tstop = Number( document.getElementById('tstop_textarea').value );
        coarse_number_steps = Number(
          document.getElementById('coarse_number_steps_textarea').value );

        k = 0;
        n = Math.max( order + 2, coarse_number_steps );
        document.getElementById("debug_textarea").value =
          "n = " + n + "\n";
        switch ( scheme ) {
          case 1: // Adams-Moulton
            ftable = new Array( order );
            ftable_old = new Array( order );
            adamsMoultonStartup();
            for ( var i = 1; i < order; i ++ ) ftable[ i ] = new Complex();
            break;
          case 2: // BDF
            ftable = new Array( order + 1 );
            ftable_old = new Array( order + 1 );
            bdfStartup();
            for ( var i = 1; i <= order; i ++ ) ftable[ i ] = new Complex();
            break;
          case 3: // explicit midpoint
            ftable = new Array(0);
            ftable_old = new Array(0);
            break;
          case 0:
            ftable = new Array( order );
            ftable_old = new Array(0);
            adamsBashforthStartup();
            for ( var i = 0; i < order; i ++ ) ftable[ i ] = new Complex();
            break;
        }
        emax = - Number.MAX_VALUE;
        emin = Number.MAX_VALUE;
        integrate();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }
      function plotError() {
        n *= 2;
        document.getElementById("debug_textarea").value =
          "n = " + n + "\n";
        integrate();
      }
    </script>
    <canvas id="plot_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="error_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    <fieldset>
      <legend> Type of scheme: </legend>
      <label for="adams_bashforth_option">
        <input
          type="radio"
          checked value="0"
          id="adams_bashforth_option_checkbox"
          name="scheme_radiobox"
        />
        Adams-Bashforth
      </label>
      <label for="adams_moulton_option">
        <input
          type="radio"
          value="1"
          id="adams_moulton_option_checkbox"
          name="scheme_radiobox"
        />
        Adams-Moulton
      </label>
      <label for="bdf_option">
        <input
          type="radio"
          value="2"
          id="bdf_option_checkbox"
          name="scheme_radiobox"
        />
        Backward Differentiation Formula
      </label>
      <label for="explicit_midpoint_option">
        <input
          type="radio"
          value="3"
          id="explicit_midpoint_option_checkbox"
          name="scheme_radiobox"
        />
        Explicit Midpoint
      </label>
    </fieldset>
    <br>
    scheme order:
    <input
      type="text"
      name="order"
      value="1"
      size=2
      id=order_textarea
    >
    <br>
    number of steps for coarsest integration:
    <input
      type="text"
      name="coarse_number_steps"
      value="1"
      size=20
      id=coarse_number_steps_textarea
    >
    <br>
    rate for differential equation y'(t) = rate * y(t): (
    <input
      type="text"
      name="rate_real"
      value="1."
      size=20
      id=rate_real_textarea
    >
    + i
    <input
      type="text"
      name="rate_imag"
      value="0."
      size=20
      id=rate_imag_textarea
    >
    )
    <br>
    stopping time:
    <input
      type="text"
      name="stopping time"
      value="1"
      size=20
      id=tstop_textarea
    >
    <br>
    <input
      type="button"
      value="Begin new refinement study"
      onclick="onStart();"
    >
    <br>
    <input
      type="button"
      value="Double number of timesteps"
      onclick="plotError();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=2
    >
    </textarea>
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
