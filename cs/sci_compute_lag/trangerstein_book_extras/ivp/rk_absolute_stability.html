<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE>Runge-Kutta absolute stability regions</TITLE>
<!--
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
-->
  </HEAD>
  <BODY>
    absolute stability regions for Runge-Kutta methods
    <br>
    <script src=../linear_algebra/Complex.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script language="javascript">
      function fcn3( r, theta, val ) {
        var one = new Complex( 1, 0 );
        var half = new Complex( .5, 0 );
        var hl = new Complex( -1 + r * Math.cos(theta),
          r * Math.sin(theta) );
        var rho = ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( half, ComplexMath.divideNumber( hl, 6 )
          ) ) ) ) );
        return ComplexMath.norm( rho ) - val * val;
      }
      function fcn3deriv( r, theta ) {
        var one = new Complex( 1, 0 );
        var half = new Complex( .5, 0 );
        var dhldr = new Complex( Math.cos(theta), Math.sin(theta) );
        var hl = ComplexMath.minus( ComplexMath.timesNumber( dhldr, r ),
          one );
        var rho = ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( half, ComplexMath.divideNumber( hl, 6 )
          ) ) ) ) );
        var drhodr = ComplexMath.times( dhldr,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( one, ComplexMath.timesNumber( hl, .5 ) ) ) ) );
        var z = ComplexMath.times( drhodr, ComplexMath.conj( rho ) );
        return 2 * z.getReal();
      }
      function solveFcn3( r, theta, val ) {
        for ( var i = 0; i < 10; i ++ ) {
          var f = fcn3( r, theta, val );
          var fprime = fcn3deriv( r, theta );
          r = r - f / fprime;
        }
        return r;
      }
      function fcn4( r, theta, val ) {
        var one = new Complex( 1, 0 );
        var half = new Complex( .5, 0 );
        var sixth = ComplexMath.divideNumber( one, 6 );
        var hl = new Complex( -1 + r * Math.cos(theta),
          r* Math.sin(theta) );
        var rho = ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( half, ComplexMath.times( hl,
          ComplexMath.plus( sixth, ComplexMath.divideNumber( hl, 24 )
          ) ) ) ) ) ) );
        return ComplexMath.norm( rho ) - val * val;
      }
      function fcn4deriv( r, theta ) {
        var one = new Complex( 1, 0 );
        var half = new Complex( .5, 0 );
        var sixth = ComplexMath.divideNumber( one, 6 );
        var dhldr = new Complex( Math.cos(theta), Math.sin(theta) );
        var hl = ComplexMath.minus( ComplexMath.timesNumber( dhldr, r ),
          one );
        var rho = ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( half, ComplexMath.times( hl,
          ComplexMath.plus( sixth, ComplexMath.divideNumber( hl, 24 )
          ) ) ) ) ) ) );
        var drhodr = ComplexMath.times( dhldr,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( one, ComplexMath.times( hl,
          ComplexMath.plus( half, ComplexMath.divideNumber( hl, 6 )
          ) ) ) ) ) );
        var z = ComplexMath.times( drhodr, ComplexMath.conj( rho ) );
        return 2 * z.getReal();
      }
      function solveFcn4( r, theta, val ) {
        for ( var i = 0; i < 10; i ++ ) {
          var f = fcn4( r, theta, val );
          var fprime = fcn4deriv( r, theta );
          r = r - f / fprime;
          if ( Math.abs( f ) <= 1.e-14 * r * Math.abs( fprime)) break;
        }
        return r;
      }
      function plotFcn4( r, theta, val ) {
        document.getElementById("debug_textarea").value +=
          "entering plotFcn4\n";
        document.getElementById("debug_textarea").value +=
          "r,theta,val = " + r + " " + theta + " " + val + "\n";
        fcn_canvas = document.getElementById("fcn_canvas");
        var x = new Array( nplot + 1 );
        var f = new Array( nplot + 1 );
        var fp = new Array( nplot + 1 );
        var rmax = 20 * r;
        var dr = rmax / nplot;
        var fmax = -Number.MAX_VALUE;
        var fmin = Number.MAX_VALUE;
        var fpmax = -Number.MAX_VALUE;
        var fpmin = Number.MAX_VALUE;
        var rr = 0;
        for ( var i = 0; i <= nplot; i ++, rr += dr ) {
          x[ i ] = rr;
          f[ i ] = fcn4( rr, theta, val ); 
          fp[ i ] = fcn4deriv( rr, theta ); 
          fmax = Math.max( fmax, f[ i ] );
          fmin = Math.min( fmin, f[ i ] );
          fmax = Math.max( fmax, fp[ i ] );
          fmin = Math.min( fmin, fp[ i ] );
        }
        fgt = new XYGraphTool( fcn_canvas, "f vs r ",
          "r", "f", 0, rmax, fmin, fmax );
        fgt.setBgColor( "white" );
        fgt.newPage();
        fgt.setFgColor( "blue" );
        fgt.beginDrawing();
          fgt.movePen( x[ 0 ], f[ 0 ] );
          for ( var i = 1; i <= nplot; i ++ ) {
            fgt.drawLine( x[ i ], f[ i ] );
          }
        fgt.endDrawing();
        fgt.setFgColor( "red" );
        fgt.beginDrawing();
          fgt.movePen( x[ 0 ], fp[ 0 ] );
          for ( var i = 1; i <= nplot; i ++ ) {
            fgt.drawLine( x[ i ], fp[ i ] );
          }
        fgt.endDrawing();
        fgt.setFgColor( "black" );
        fgt.drawAxes();
        document.getElementById("debug_textarea").value +=
          "leaving plotFcn4\n";
      }

//    var nplot=4096;
      var nplot=128;
      var scheme = 0;
// modified Euler:0, Heun 3rd order:1, classical RK: 2, 2 stage 4th order: 3

      var xpoint = new Array( nplot + 1 );
      var ypoint = new Array( nplot + 1 );
      var x1point = new Array( nplot + 1 );
      var y1point = new Array( nplot + 1 );
      var x9point = new Array( nplot + 1 );
      var y9point = new Array( nplot + 1 );
      var xmin = Number.MAX_VALUE;
      var xmax = -Number.MAX_VALUE;
      var ymin = Number.MAX_VALUE;
      var ymax = -Number.MAX_VALUE;
      var dtheta = 2. * Math.PI / nplot;

      function modifiedEuler( ) {
        var theta = 0.;
        xmin = Number.MAX_VALUE;
        xmax = -Number.MAX_VALUE;
        ymin = Number.MAX_VALUE;
        ymax = -Number.MAX_VALUE;
        var cone = new Complex( 1., 0. );
        for ( var j = 0; j <= nplot; j++, theta += dtheta ) {
          var cs = Math.cos( 2 * theta );
          var r = Math.sqrt( Math.sqrt( 3. + cs * cs ) - cs );
          var point = new Complex( -1 + r * Math.cos( theta ),
            r * Math.sin( theta ) );
          xpoint[ j ] = point.getReal();
          ypoint[ j ] = point.getImag();
          xmin = Math.min( xmin, xpoint[ j ] );
          xmax = Math.max( xmax, xpoint[ j ] );
          ymin = Math.min( ymin, ypoint[ j ] );
          ymax = Math.max( ymax, ypoint[ j ] );

          r = Math.sqrt( Math.sqrt( 2.24 + cs * cs ) - cs );
          point = new Complex( -1 + r * Math.cos( theta ),
            r * Math.sin( theta ) );
          x9point[ j ] = point.getReal();
          y9point[ j ] = point.getImag();
          xmin = Math.min( xmin, x9point[ j ] );
          xmax = Math.max( xmax, x9point[ j ] );
          ymin = Math.min( ymin, y9point[ j ] );
          ymax = Math.max( ymax, y9point[ j ] );

          r = Math.sqrt( Math.sqrt( 3.84 + cs * cs ) - cs );
          point = new Complex( -1 + r * Math.cos( theta ),
            r * Math.sin( theta ) );
          x1point[ j ] = point.getReal();
          y1point[ j ] = point.getImag();
          xmin = Math.min( xmin, x1point[ j ] );
          xmax = Math.max( xmax, x1point[ j ] );
          ymin = Math.min( ymin, y1point[ j ] );
          ymax = Math.max( ymax, y1point[ j ] );
        }
      }

      function heun3rdOrder( ) {
        var theta = 0.;
        var r = 1;
        xmin = Number.MAX_VALUE;
        xmax = -Number.MAX_VALUE;
        ymin = Number.MAX_VALUE;
        ymax = -Number.MAX_VALUE;
        for ( var j = 0; j <= nplot; j++, theta += dtheta ) {
          var rnew = solveFcn3( r, theta, 1 );
          xpoint[ j ] = -1 + rnew * Math.cos( theta );
          ypoint[ j ] = rnew * Math.sin( theta );
          xmin = Math.min( xmin, xpoint[ j ] );
          xmax = Math.max( xmax, xpoint[ j ] );
          ymin = Math.min( ymin, ypoint[ j ] );
          ymax = Math.max( ymax, ypoint[ j ] );

          rnew = solveFcn3( r, theta, .9 );
          x9point[ j ] = -1 + rnew * Math.cos( theta );
          y9point[ j ] = rnew * Math.sin( theta );
          xmin = Math.min( xmin, x9point[ j ] );
          xmax = Math.max( xmax, x9point[ j ] );
          ymin = Math.min( ymin, y9point[ j ] );
          ymax = Math.max( ymax, y9point[ j ] );

          rnew = solveFcn3( r, theta, 1.1 );
          x1point[ j ] = -1 + rnew * Math.cos( theta );
          y1point[ j ] = rnew * Math.sin( theta );
          xmin = Math.min( xmin, x1point[ j ] );
          xmax = Math.max( xmax, x1point[ j ] );
          ymin = Math.min( ymin, y1point[ j ] );
          ymax = Math.max( ymax, y1point[ j ] );

          r = rnew;
        }
      }
      function classicalRK( ) {
        var theta = 0.;
        var r = 1;
        xmin = Number.MAX_VALUE;
        xmax = -Number.MAX_VALUE;
        ymin = Number.MAX_VALUE;
        ymax = -Number.MAX_VALUE;
        for ( var j = 0; j <= nplot; j++, theta += dtheta ) {
          var rnew = solveFcn4( r, theta, 1 );
          xpoint[ j ] = -1 + rnew * Math.cos( theta );
          ypoint[ j ] = rnew * Math.sin( theta );
          xmin = Math.min( xmin, xpoint[ j ] );
          xmax = Math.max( xmax, xpoint[ j ] );
          ymin = Math.min( ymin, ypoint[ j ] );
          ymax = Math.max( ymax, ypoint[ j ] );

          rnew = solveFcn4( r, theta, .9 );
          x9point[ j ] = -1 + rnew * Math.cos( theta );
          y9point[ j ] = rnew * Math.sin( theta );
          xmin = Math.min( xmin, x9point[ j ] );
          xmax = Math.max( xmax, x9point[ j ] );
          ymin = Math.min( ymin, y9point[ j ] );
          ymax = Math.max( ymax, y9point[ j ] );

          rnew = solveFcn4( r, theta, 1.1 );
          x1point[ j ] = -1 + rnew * Math.cos( theta );
          y1point[ j ] = rnew * Math.sin( theta );
          xmin = Math.min( xmin, x1point[ j ] );
          xmax = Math.max( xmax, x1point[ j ] );
          ymin = Math.min( ymin, y1point[ j ] );
          ymax = Math.max( ymax, y1point[ j ] );

          r = rnew;
        }
      }
      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        var radio_buttons =
          document.getElementsByName("scheme_radiobox");
        for ( var i = 0; i < radio_buttons.length; i ++ ) {
          if ( radio_buttons[ i ].checked ) {
            scheme = Number( radio_buttons[ i ].value );
            break;
          }
        }
        switch ( scheme ) {
          case 0:
            modifiedEuler();
            break;
          case 1:
            heun3rdOrder();
            break;
          default:
            classicalRK();
            break;
        }
        plot_canvas = document.getElementById("plot_canvas");
        gt = new XYGraphTool( plot_canvas, "h * lambda plane ",
          "Real", "Imag", xmin, xmax, ymin, ymax );
        gt.setBgColor( "white" );
        gt.newPage();
        gt.setFgColor( "blue" );
        gt.beginDrawing();
          gt.movePen( xpoint[ 0 ], ypoint[ 0 ] );
          for ( var i = 1; i <= nplot; i ++ ) {
            gt.drawLine( xpoint[ i ], ypoint[ i ] );
          }
        gt.endDrawing();

        gt.setFgColor( "green" );
        gt.beginDrawing();
          gt.movePen( x9point[ 0 ], y9point[ 0 ] );
          for ( var i = 1; i <= nplot; i ++ ) {
            gt.drawLine( x9point[ i ], y9point[ i ] );
          }
        gt.endDrawing();

//      gt.setFgColor( "red" );
//      gt.beginDrawing();
//        gt.movePen( x1point[ 0 ], y1point[ 0 ] );
//        for ( var i = 1; i <= nplot; i ++ ) {
//          gt.drawLine( x1point[ i ], y1point[ i ] );
//        }
//      gt.endDrawing();
        gt.setFgColor( "black" );
        gt.drawAxes();

//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }
    </script>
    <canvas id="plot_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="fcn_canvas" width="500" height="300">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    <fieldset>
      <legend> linear multistep method: </legend>
      <label for="modified_euler_option">
        <input
          type="radio"
          checked value="0"
          id="modified_euler_option_checkbox"
          name="scheme_radiobox"
        />
        Modified Euler
      </label>
      <label for="heun_third_order_option">
        <input
          type="radio"
          value="1"
          id="heun_third_order_option_checkbox"
          name="scheme_radiobox"
        />
        Heun 3rd Order
      </label>
      <label for="classical_rk_option">
        <input
          type="radio"
          value="2"
          id="classical_rk_option_checkbox"
          name="scheme_radiobox"
        />
        Classical Runge-Kutta
      </label>
    </fieldset>
    <br>
    <input
      type="button"
      value="click to draw absolute stability region"
      onclick="onStart();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=50
    >
    </textarea>
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
