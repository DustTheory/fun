<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Symmetric Indefinite Factorization </TITLE>
  </HEAD>
  <BODY>
    <h2> Symmetric Indefinite Factorization </h2>
    <script src=JSMatrix.js></script>
    <script src=Complex.js></script>
    <script src=BooleanReference.js></script>
    <script src=IntReference.js></script>
    <script src=StringReference.js></script>
    <script src=NumberReference.js></script>
    <script src=LaPack2.js></script>
    <script src=LaPack1.js></script>
    <script src=LaPack0.js></script>
    <script src=Blas3.js></script>
    <script src=Blas2.js></script>
    <script src=Blas1.js></script>
    <script language="javascript">
    var matrix_text="1;2,1;-1,1,3";

    function factorMatrix( ) {
      matrix_text=document.getElementsByName('matrix_text')[0].value;
      document.getElementById("row_pivot_textarea").value="";
      document.getElementById("left_factor_textarea").value="";
      document.getElementById("diagonal_factor_textarea").value="";
      document.getElementById("factor_error_textarea").value="";
      var m = new JSMatrix();
      m.parse( matrix_text );
//    for ( i = 0; i < m.numberRows(); i ++ ) {
//      document.getElementById("debug_textarea").value +=
//        "m[ " + i + " , * ] = ";
//      for ( j = 0; j <= i; j ++ ) {
//        document.getElementById("debug_textarea").value +=
//          m.getEntry( i, j ) + " ";
//      }
//      document.getElementById("debug_textarea").value += "\n";
//    }

      var mf = new JSMatrix();
      mf.copy( m );

      var ipiv = new Array( mf.numberRows() );
      var info = new IntReference();
      var lwork = -1;
      var work = new Array( 1 );
      LaPack1.dsytrf( 'L', mf.numberRows(), mf.dataArray(), mf.numberRows(),
        ipiv, work, lwork, info, 0, 0, 0 );
      lwork = Math.round( work[0] );
      work = new Array( lwork );
      LaPack1.dsytrf( 'L', mf.numberRows(), mf.dataArray(), mf.numberRows(),
        ipiv, work, lwork, info, 0, 0, 0 );

      var rank = info.getValue();
      if ( rank == 0 ) rank = mf.numberRows();

//    display left factor
      var sa = new Array( mf.numberRows() * mf.numberCols() );
      var cw = new Array( mf.numberCols() );
      var j = 0;
      while ( j < rank ) {
        if ( ipiv[ j ] > 0 ) {
          sa[ j + j * mf.numberRows() ] = new String();
          sa[ j + j * mf.numberRows() ] = '1';
          cw[ j ] = sa[ j + j * mf.numberRows() ].length;
          for ( i = j + 1; i < mf.numberRows(); i ++ ) {
            sa[ i + j * mf.numberRows() ] = 
              scientificFormat( mf.getEntry( i, j ) );
            cw[ j ]=
              Math.max( sa[ i + j * mf.numberRows() ].length, cw[ j ] );
          }
          j ++ ;
        } else {
          var i = j;
          sa[ i + j * mf.numberRows() ] = new String();
          sa[ i + j * mf.numberRows() ] = '1';
          cw[ j ] = sa[ i + j * mf.numberRows() ].length;
          i = j + 1;
          sa[ i + j * mf.numberRows() ] = new String();
          sa[ i + j * mf.numberRows() ] = '0';
          cw[ j ] = 
            Math.max( sa[ i + j * mf.numberRows() ].length, cw[ j ] );;
          for ( i = j + 2; i < mf.numberRows(); i ++ ) {
            sa[ i + j * mf.numberRows() ] = 
              scientificFormat( mf.getEntry( i, j ) );
            cw[ j ]=
              Math.max( sa[ i + j * mf.numberRows() ].length, cw[ j ] );
          }
          j ++ ;
          i = j;
          sa[ i + j * mf.numberRows() ] = new String();
          sa[ i + j * mf.numberRows() ] = '1';
          cw[ j ] = sa[ i + j * mf.numberRows() ].length;
          for ( i = j + 1; i < mf.numberRows(); i ++ ) {
            sa[ i + j * mf.numberRows() ] = 
              scientificFormat( mf.getEntry( i, j ) );
            cw[ j ]=
              Math.max( sa[ i + j * mf.numberRows() ].length, cw[ j ] );
          }
          j ++ ;
        }
      }
      document.getElementById("left_factor_textarea").style.color = "green";
      document.getElementById("row_pivot_textarea").style.color = "green";
      for ( var i = 0; i < mf.numberRows(); i ++ ) {
        var str = new String();
        for ( var j = 0; j < Math.min( i, rank ); j ++ ) {
          var sj = sa[ i + j * mf.numberRows() ];
          while ( sj.length < cw[ j ] ) sj += ' ';
          str += sj + ' ';
        }
        if ( i < rank ) str += '1';
        document.getElementById("left_factor_textarea").value += str + "\n";
        if ( i < rank - 1 ) {
          document.getElementById("row_pivot_textarea").value +=
            ipiv[i] + "\n";
        }
      }

//    display diagonal factor
      var k = 0;
      while ( k < rank ) {
        var k1 = ( ipiv[ k ] > 0 ? k : k + 1 );
        for ( var j = k; j <= k1; j ++ ) {
          cw[ j ] = 0;
          for ( var i = k; i <= k1; i ++ ) {
            sa[ i + j * mf.numberRows() ] = 
              scientificFormat( mf.getEntry( i, j ) );
            cw[ j ] =
              Math.max( cw[ j ], sa[ j + j * mf.numberRows() ].length );
          }
        }
        k += ( ipiv[ k ] > 0 ? 1 : 2 );
      }
      document.getElementById("diagonal_factor_textarea").style.color =
        "purple";
      var k = 0;
      while ( k < rank ) {
        k1 = ( ipiv[ k ] > 0 ? k : k + 1 );
        for ( var i = k; i <= k1; i ++ ) {
          var str2 = new String();
          for ( var j = 0; j < k; j ++ ) {
            var sj2 = '';
            while ( sj2.length < cw[ j ] ) sj2 = ' ' + sj2;
            str2 += sj2 + ' ';
          }
          for ( j = k; j <= i; j ++ ) {
            sj2 = sa[ i + j * mf.numberRows() ].toString();
            str2 += sj2 + ' ';
          }
          document.getElementById("diagonal_factor_textarea").value +=
            str2 + "\n";
        }
        k += ( ipiv[ k ] > 0 ? 1 : 2 );
      }
//    compute A - M * D * transpose( M )
//    [ M    ] [ D       ] [ M' m ] = [  M D M'   M D m         ]
//    [ m' I ] [   Delta ] [    I ] = [ m' D M'  m' D m + Delta ]
      var p = new JSMatrix( mf.numberRows(), mf.numberCols(), 0 );
      var k = 0;
      while ( k < rank ) {
//      compute D m and store in k'th ( and k+1'th ) column of p:
        var k1 = ( ipiv[ k ] > 0 ? k : k + 1 );
        if ( k > 0 ) {
          for ( var j = k; j <= k1; j ++ ) {
            var i = 0;
            while ( i < k ) {
              if ( ipiv[ i ] > 0 ) {
                p.setEntry( i, j,
                  mf.getEntry( i, i ) * mf.getEntry( j, i ) );
                i ++ ;
              } else {
                var ip1 = i + 1;
                p.setEntry( i, j, mf.getEntry( i, i ) * mf.getEntry( j, i )
                          + mf.getEntry( ip1, i ) * mf.getEntry( j, ip1 ) );
                p.setEntry( ip1, j,
                    mf.getEntry( ip1, i ) * mf.getEntry( j, i )
                  + mf.getEntry( ip1, ip1 ) * mf.getEntry( j, ip1 ) );
                i += 2;
              }
            }
          }
        }
//      compute m' ( D m ) + Delta:
        for ( var j = k; j <= k1; j ++ ) {
          for ( var i = j; i <= k1; i ++ ) {
            p.setEntry( i, j, mf.getEntry( i, j )
              + Blas1.ddot( k, mf.dataArray(), mf.numberRows(),
                p.dataArray(), 1, i, j * p.numberRows() ) );
          }
        }
//      compute M ( D m ) and store in k'th ( and k+1'th ) rows of p:
        if ( k > 0 ) {
          for ( var j = k; j <= k1; j ++ ) {
            var i = 0;
            while ( i < k ) {
              var i1 = ( ipiv[ i ] > 0 ? i : i + 1 );
              for ( ii = i; ii <= i1; ii ++ ) {
                p.setEntry( j, ii, p.getEntry( ii, j )
                  + Blas1.ddot( i, mf.dataArray(), mf.numberRows(),
                    p.dataArray(), 1, ii, j*p.numberRows() ) );
              }
              i += ( ipiv[ i ] > 0 ? 1 : 2 );
            }
          }
        }
        k += ( ipiv[ k ] > 0 ? 1 : 2 );
      }
      var i = rank - 2;
      while ( i >= 0 ) {
        var ipi = ( ipiv[ i ] > 0 ? ipiv[ i ] - 1 : - ipiv[ i ] - 1 );
        if ( ipi != i ) {
          Blas1.dswap( p.numberCols(), p.dataArray(), p.numberRows(),
            p.dataArray(), p.numberRows(), i, ipi );
          Blas1.dswap( p.numberRows(), p.dataArray(), 1, p.dataArray(), 1,
            i * p.numberRows(), ipi * p.numberRows() );
        }
        i -= ( ipiv[ i ] > 0 ? 1 : 2 );
      }
      for ( var j = 0; j < m.numberCols(); j ++ ) {
        for ( var i = j; i < m.numberRows(); i ++ ) {
          p.setEntry( i, j, m.getEntry( i, j ) - p.getEntry( i, j ) );
        }
      }
//    compute entry lengths
      for ( var j=0; j < p.numberCols(); j ++ ) {
        cw[ j ] = 0;
        for ( var i = j; i < p.numberRows(); i ++ ) {
          cw[ j ] = Math.max( cw[ j ],
            scientificFormat( p.getEntry( i, j ) ).length);
        }
      }
//    display A - L * R
      document.getElementById("factor_error_textarea").style.color = "blue";
      for ( var i = 0; i < p.numberRows(); i ++ ) {
        var str3 = new String();
        for ( var j = 0; j < i; j ++ ) {
          var sj3 = scientificFormat( p.getEntry( i, j ) );
          while ( sj3.length < cw[ j ] ) sj3 += ' ';
          str3 += sj3 + " ";
        }
        str3 += scientificFormat( p.getEntry( i, i ) );
        document.getElementById("factor_error_textarea").value += str3
          + "\n";
      }
    }

    function scientificFormat( n ) {
      var an = Math.abs(n);
      if ( an>=0.01 && an<=100. ) return n.toString();
      else return n.toExponential();
    }
    </script>
    Enter lower triangular part of matrix:
    <input
      type="text"
      name="matrix_text"
      value="1;2,1;-1,1,3"
      size="50"
    >
    <input
      type="button"
      value="Factor"
      onclick="matrix_text=document.getElementsByName('matrix_text')[0].value;factorMatrix();"
    >
    <br>
    ipiv:
    <br>
    <textarea
      id="row_pivot_textarea"
      cols=3
      rows=10
    >
    </textarea>
    <br>
    M:
    <br>
    <textarea
      id="left_factor_textarea"
      cols=100
      rows=10
    >
    </textarea>
    <br>
    D:  
    <br>
    <textarea
      id="diagonal_factor_textarea"
      cols=100
      rows=10
    >
    </textarea>
    <br>
    A - Q * M * D * transpose( M ) * transpose( Q ):
    <br>
    <textarea
      id="factor_error_textarea"
      cols=100
      rows=10
    >
    </textarea>
<!--
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=50
    >
    </textarea>
-->
    <script language="javascript"> factorMatrix(); </script>
  </BODY>
</HTML>
