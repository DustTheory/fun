<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Romberg Integration </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script language="javascript"> 
//    function f(x) {
//      if ( x <= 0 || x >= 2 * Math.PI ) return 0;
//      return Math.exp( 1 / Math.pow( Math.PI, 2 )
//        - 1 / ( x * ( 2 * Math.PI - x ) ) );
//    }
//    var a = 0;
//    var b = 2 * Math.PI;
//    var exact = ( 5.540732011832717 + 5.54073201028181 ) / 2;

      function f(x) { return Math.exp(x); }
      var a = 0;
      var b = 1;
      var exact = Math.exp( 1 ) - 1;

//    function f(x) { return Math.sqrt(x); }
//    var a = 0;
//    var b = 1;
//    var exact = 2 / 3;

      function riemann( ) {
        var sum =  0;
        var dx = len / n;
        var x = a;
        for ( var i = 0; i < n; i ++, x += dx ) sum += f(x);
        sum *= dx;
        return sum;
      }
      function midpoint( ) {
        var sum =  0;
        var dx = len / n;
        var x = a + dx * 0.5;
        for ( var i = 0; i < n; i ++, x += dx ) sum += f(x);
        sum *= dx;
        return sum;
      }
      function trapezoidal( ) {
        var sum =  0;
        var dx = len / n;
        var x = a + dx;
        for ( var i = 1; i < n; i ++, x += dx ) sum += f(x);
        sum = ( sum + ( f( a ) + f( b ) ) * 0.5 ) * dx;
        return sum;
      }


      var len = b - a;
      var type = 0; // Riemann:0, midpoint:1, trapezoidal:2
      var n = 1;
      var k = 0;
      var h = len;
      var x_array = new Array( 1 );
      var y_array = new Array( 1 );
      var table = new Array( 1 );
      var colors = [ "blue", "cyan", "green", "yellow", "red", "magenta",
        "brown", "black" ];

      var alpha = 2;
      var alpha2 = 1;
      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        var radio_buttons =
          document.getElementsByName("quadrature_radiobox");
        for ( var i = 0; i < radio_buttons.length; i ++ ) {
          if ( radio_buttons[ i ].checked ) {
            type = Number( radio_buttons[ i ].value );
            break;
          }
        }
        n = 1;
        k = 0;
        h = len / n;
//      document.getElementById("debug_textarea").value +=
//        "type = " + type + "\n";
        var result = 0;
        switch ( type ) {
          case 0:
            result = riemann();
            break;
          case 1:
            result = midpoint();
            break;
          case 2:
            result = trapezoidal();
            break;
        }
        alpha2 = ( type == 0 ? alpha : alpha * alpha );
        alpha_power = alpha2;
        x_array[ k ] = h;
        y_array[ k ] = result;
        table[ k ] = new Array( 1 );
        table[ k ][ 0 ] = result;
//      document.getElementById("debug_textarea").value +=
//        "k = " + k + "\n";
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function plotError() {
//      document.getElementById("debug_textarea").value +=
//        "entering plotError\n";
        n *= 2;
        k ++;
        h /= alpha;
        if ( k >= colors.length ) return;
//      document.getElementById("debug_textarea").value +=
//        "n,k = " + n + " " + k + "\n";
        switch ( type ) {
          case 0:
            result = riemann();
            break;
          case 1:
            result = midpoint();
            break;
          case 2:
            result = trapezoidal();
            break;
        }
        x_array[ k ] = h;
        var quad = result;
        table[ k ] = new Array( k + 1 );
        alpha_power = alpha2;
        for ( var i = 0; i < k; i ++ ) {
          var next_quad = quad + ( quad - y_array[ i ] )
            * 1 / ( alpha_power - 1 );
          y_array[ i ] = quad;
          table[ k ][ i ] = quad;
          quad = next_quad;
          alpha_power *= alpha2;
        }
        y_array[ k ] = quad;
        table[ k ][ k ] = quad;
        document.getElementById("debug_textarea").value =
          "quad = " + quad + "\n";

        var cnvs = document.getElementById("plot_canvas");
        gt = new XYGraphTool( cnvs, "error in centered differences",
          "h","error", - Math.LOG10E * Math.log( x_array[ 0 ] ), 
          - Math.LOG10E * ( Math.log( x_array[ 0 ] )
          - ( colors.length - 1 ) * Math.log( alpha ) ), -16, 0 );

        gt.setBgColor( "white" );
        gt.newPage();
        gt.setFgColor( "black" );
        gt.drawAxes();
        
        for ( var j = 0; j <= k; j ++ ) {
          gt.setFgColor( colors[ j ] );
          gt.beginDrawing();
            var logh = - Math.LOG10E * Math.log( x_array[ j ] );
//          document.getElementById("debug_textarea").value +=
//            "j,k = " + j + " " + k + "\n";
//          document.getElementById("debug_textarea").value +=
//            "table[ " + j + " ].length = " + table[ j ].length + "\n";
            var logerr = Math.LOG10E * Math.log(
              Math.max( 1.e-17, Math.abs( table[ j ][ j ] - exact ) ) );
            gt.drawPlus( logh, logerr, 0.04 );
            gt.movePen( logh, logerr );
            for ( var i = j + 1; i <= k; i++ ) {
              logh = - Math.LOG10E * Math.log( x_array[ i ] );
              logerr = Math.LOG10E * Math.log(
                Math.max( 1.e-17, Math.abs( table[ i ][ j ] - exact ) ) );
              gt.drawLine( logh, logerr );
            }
          gt.endDrawing();
        }
//      document.getElementById("debug_textarea").value +=
//        "leaving plotError\n";
      }
    </script>
  </HEAD>
  <BODY>
    <h2>
      Romberg integration to compute
      $$\int_0^1 e^x \; d x$$
    </h2>

    <canvas
      id="plot_canvas"
      width="500"
      height="300"
    >
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    <fieldset>
      <legend> Type of quadrature: </legend>
      <label for="riemann_option">
        <input
          type="radio"
          checked value="0"
          id="riemann_option_checkbox"
          name="quadrature_radiobox"
        />
        Riemann
      </label>
      <label for="midpoint_option">
        <input
          type="radio"
          value="1"
          id="midpoint_option_checkbox"
          name="quadrature_radiobox"
        />
        midpoint
      </label>
      <label for="trapezoidal_option">
        <input
          type="radio"
          value="2"
          id="trapezoidal_option_checkbox"
          name="quadrature_radiobox"
        />
        trapezoidal
      </label>
    </fieldset>
    <input
      type="button"
      value="Begin new refinement study"
      onclick="onStart();"
    >
    <br>
    <input
      type="button"
      value="Double number of mesh points"
      onclick="plotError();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=2
    >
    </textarea>
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
<html><head></head><body></body></html>
