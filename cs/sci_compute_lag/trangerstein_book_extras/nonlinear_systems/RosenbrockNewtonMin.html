<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Rosenbrock minimization via Newton </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/glMatrix-0.9.5.min.js></script>
    <script src=../plotting/AreaGraphTool.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script src=../plotting/Colormap.js></script>
    <script src=../plotting/Palette.js></script>
  </HEAD>
  <BODY>
    <h2>
      Rosenbrock's function
      \( f(x,y) = \pi + \frac{1}{2} \left\|
        \begin{bmatrix} 10 (y-x^2) \\ 1-x \end{bmatrix} \right\|_2^2 \)
    </h2>
    <script language="javascript">
      var gt = undefined;
      var gt2 = undefined;
      var cm = undefined;
      var nc = [ 100, 100 ];
      var low = [ -2, -2 ];
      var high = [ 2, 2 ];
      var roundoff = undefined;
      var sqrtrnd = undefined;
      var npts = 500;
      var itmax = 5;
      var h = 0.01;

      function f( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return Math.PI + 0.5 * ( a * a + b * b );
      }
      function gf( x, y ) { // gradient of f
        var a=10*(y-x*x);
        var b=1-x;
        var retval = new Array( -20 * x * a - b, 10 * a );
        return retval;
      }
      function Hf( x, y ) { // Hessian of f
        var a=10*(y-x*x);
        var b=1-x;
        return new Array( -20 * a + 400 * x * x + 1, - 200 * x,
                         -200 * x, 100 );
      }
      function hessianNonnegative( x ) {
        return x * x + 0.005;
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        roundoff = 1;
        while ( 1 - roundoff < 1 ) roundoff *= 0.5;
        roundoff *=2.
        sqrtrnd = Math.sqrt( roundoff );
        itmax
          = Number( document.getElementsByName('itmax_input')[0].value );
        h = Number( document.getElementsByName('h_input')[0].value );

        var p = new Palette();
        cm = new Colormap( p );
        gt = new AreaGraphTool(
          document.getElementById("contour_canvas"),"contour test",
          "x", "y ", low, high, cm );
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.setFgColor( undefined );
        gt.beginDrawing();
          s = low[ 0 ];
          ds = ( high[ 0 ] - s ) / npts;
          var hn = hessianNonnegative( s );
          var inbounds = low[ 0 ] <= s && s <= high[ 0 ]
            && low[ 1 ] <= hn && hn <= high[ 1 ];
          if ( inbounds ) {
            var pen = new Array( s, hn );
            gt.movePen( pen );
          }
          s += ds;
          for ( var i = 1; i <= npts; i ++, s += ds ) {
            hn = hessianNonnegative( s );
            var next_inbounds = low[ 0 ] <= s && s <= high[ 0 ]
              && low[ 1 ] <= hn && hn <= high[ 1 ];
            if ( inbounds ) {
              var pen = new Array( s, hn );
              gt.drawLine( pen );
            } else if ( next_inbounds ) {
              var pen = new Array( s, hn );
              gt.movePen( pen );
            }
            inbounds = next_inbounds;
          }
        gt.endDrawing();
        gt.mouseUp = iterate;
        gt.watchMouse();
        gt.listen();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function iterate( e ) {
//      document.getElementById("debug_textarea").value +=
//        "entering iterate\n";
        var guess = new Array( gt.mouse_coords[0], gt.mouse_coords[1] ); 
        var errmin = Number.MAX_VALUE;
        var errmax = - Number.MAX_VALUE;

//      analytical derivatives
//      document.getElementById("debug_textarea").value +=
//        "\nanalytical derivatives\n";
        var soln = new Array( guess[ 0 ], guess[ 1 ] );
        var error0 = new Array( itmax );
        for ( var it = 0; it < itmax; it ++ ) {
          var gfval = gf( soln[0], soln[1] );
          error0[ it ] = Math.max( -16, Math.log(
            Math.abs( gfval[ 0 ] ) + Math.abs( gfval[ 1 ] ) ) );
          errmin = Math.min( errmin, error0[ it ] );
          errmax = Math.max( errmax, error0[ it ] );
          var Hfval = Hf( soln[0], soln[1] );
          var det = Hfval[ 0 ] * Hfval[ 3 ] - Hfval[ 1 ] * Hfval[ 2 ];
          var newton = new Array( 
            ( Hfval[ 2 ] * gfval[ 1 ] - Hfval[ 3 ] * gfval[ 0 ] ) / det,
            ( Hfval[ 1 ] * gfval[ 0 ] - Hfval[ 0 ] * gfval[ 1 ] ) / det );
          soln[ 0 ] += newton[ 0 ];
          soln[ 1 ] += newton[ 1 ];
        }

//      analytical gradient, finite difference Hessian
//      document.getElementById("debug_textarea").value +=
//        "\nanalytical gradient, h = " + h + "\n";
        soln[ 0 ] = guess[ 0 ];
        soln[ 1 ] = guess[ 1 ];
        var error1 = new Array( itmax );
        for ( var it = 0; it < itmax; it ++ ) {
          var gfval = gf( soln[0], soln[1] );
          error1[ it ] = Math.max( -16, Math.log(
            Math.abs( gfval[ 0 ] ) + Math.abs( gfval[ 1 ] ) ) );
          errmin = Math.min( errmin, error1[ it ] );
          errmax = Math.max( errmax, error1[ it ] );
          var Hfval = new Array( 4 );
          var xn = soln[ 0 ] + h;
          var gfvaln = gf( xn, soln[ 1 ] );
          Hfval[ 0 ] = ( gfvaln[ 0 ] - gfval[ 0 ] ) / h;
          Hfval[ 1 ] = ( gfvaln[ 1 ] - gfval[ 1 ] ) / h;
          var yn = soln[ 1 ] + h;
          var gfvalnn = gf( soln[ 0 ], yn );
          Hfval[ 2 ] = ( gfvalnn[ 0 ] - gfval[ 0 ] ) / h;
          Hfval[ 3 ] = ( gfvalnn[ 1 ] - gfval[ 1 ] ) / h;
          Hfval[ 1 ] = ( Hfval[ 1 ] + Hfval[ 2 ] ) * 0.5;
          Hfval[ 2 ] = Hfval[ 1 ];
          var det = Hfval[ 0 ] * Hfval[ 3 ] - Hfval[ 1 ] * Hfval[ 2 ];
          var newton = new Array( 
            ( Hfval[ 2 ] * gfval[ 1 ] - Hfval[ 3 ] * gfval[ 0 ] ) / det,
            ( Hfval[ 1 ] * gfval[ 0 ] - Hfval[ 0 ] * gfval[ 1 ] ) / det );
          Hfval = Hf( soln[0], soln[1] );
          var det = Hfval[ 0 ] * Hfval[ 3 ] - Hfval[ 1 ] * Hfval[ 2 ];
          soln[ 0 ] += newton[ 0 ];
          soln[ 1 ] += newton[ 1 ];
        }

//      finite difference gradient and Hessian
//      document.getElementById("debug_textarea").value +=
//        "\nfinite differences\n";
        soln[ 0 ] = guess[ 0 ];
        soln[ 1 ] = guess[ 1 ];
        var error2 = new Array( itmax );
        for ( var it = 0; it < itmax; it ++ ) {
          var fval = f( soln[0], soln[1] );
          var f0val = f( soln[0] + h, soln[1] );
          var f1val = f( soln[0], soln[1] + h );
          var gfval = new Array( 2 );
          gfval[ 0 ] = ( f0val - fval ) / h; 
          gfval[ 1 ] = ( f1val - fval ) / h; 
          error2[ it ] = Math.max( -16, Math.log(
            Math.abs( gfval[ 0 ] ) + Math.abs( gfval[ 1 ] ) ) );
          errmin = Math.min( errmin, error2[ it ] );
          errmax = Math.max( errmax, error2[ it ] );
          var Hfval = new Array( 4 );
          Hfval[ 0 ] = ( ( f( soln[ 0 ] + 2 * h , soln[ 1 ] ) - f0val ) / h
            - gfval[ 0 ] ) / h;
          Hfval[ 1 ] = ( ( f( soln[ 0 ] + h, soln[ 1 ] + h ) - f0val ) / h
            - gfval[ 1 ] ) / h;
          Hfval[ 2 ] = Hfval[ 1 ];
          Hfval[ 3 ] = ( ( f( soln[ 0 ], soln[ 1 ] + 2 * h ) - f1val ) / h
            - gfval[ 1 ] ) / h;
          var det = Hfval[ 0 ] * Hfval[ 3 ] - Hfval[ 1 ] * Hfval[ 2 ];
          var newton = new Array( 
            ( Hfval[ 2 ] * gfval[ 1 ] - Hfval[ 3 ] * gfval[ 0 ] ) / det,
            ( Hfval[ 1 ] * gfval[ 0 ] - Hfval[ 0 ] * gfval[ 1 ] ) / det );
          soln[ 0 ] += newton[ 0 ];
          soln[ 1 ] += newton[ 1 ];
        }
//      document.getElementById("debug_textarea").value +=
//        "new XYGraphTool, itmax,errmin,errmax = " + itmax + " "
//        + errmin + " " + errmax + "\n";
        gt2 = new XYGraphTool(
          document.getElementById("error_canvas"),
          "log error versus iteration", "iteration", "log(error)",
          0, itmax-1, errmin, errmax );
        gt2.setBgColor( "white" );
        gt2.newPage();
        gt2.setFgColor( "black" );
        gt2.drawAxes();
        gt2.setFgColor( "red"  );
        gt2.beginDrawing();
          gt2.movePen( 0, error0[ 0 ] );
          for ( var it = 1; it < itmax; it ++ ) {
            gt2.drawLine( it, error0[ it ] );
          }
        gt2.endDrawing();
        gt2.setFgColor( "green"  );
        gt2.beginDrawing();
          gt2.movePen( 0, error1[ 0 ] );
          for ( var it = 1; it < itmax; it ++ ) {
            gt2.drawLine( it, error1[ it ] );
          }
        gt2.endDrawing();
        gt2.setFgColor( "blue"  );
        gt2.beginDrawing();
          gt2.movePen( 0, error2[ 0 ] );
          for ( var it = 1; it < itmax; it ++ ) {
            gt2.drawLine( it, error2[ it ] );
          }
        gt2.endDrawing();
//      document.getElementById("debug_textarea").value +=
//        "leaving iterate\n";
      }
      function checkNumber(n) {
        if (!isFinite(n)) {
          alert("entered value is not a NUMBER");
          return false;
        }
        return true;
      }
    </script>
    <canvas id="contour_canvas" width="400" height="400">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="error_canvas" width="400" height="400">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
<!--
    Steepest descent direction in red, Newton in green
-->
    <br>
    Click mouse in contour plot to select initial guess for iteration
    <br>
    ( Points below black curve have positive Hessian )
    <br>
    max number iterations
    <input
      type="number"
      name="itmax_input"
      value="20"
      onchange="checkNumber(document.getElementsByName('itmax_input')[0].value);"
      size=20
    >
    <br>
    finite difference increment
    <input
      type="number"
      name="h_input"
      value="0.01"
      onchange="checkNumber(document.getElementsByName('h_input')[0].value);"
      size=20
    >
    <br>
    Error plots on right: red(analytical derivatives),
      green(analytical gradient),
      blue(finite differences for all derivatives)
    <br>
    <input
      type="button"
      value="Start Over"
      onclick="onStart();"
    >
<!--
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=2
    >
    </textarea>
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
