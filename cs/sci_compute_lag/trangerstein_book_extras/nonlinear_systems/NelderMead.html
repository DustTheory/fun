<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Nelder-Mead minimization </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/AreaGraphTool.js></script>
    <script src=../plotting/Colormap.js></script>
    <script src=../plotting/Palette.js></script>
    <script src=../linear_algebra/Complex.js></script>
    <script src=../linear_algebra/Vector.js></script>
  </HEAD>
  <BODY>
    <h2>
      Nelder-Mead algorithm for Rosenbrock's function
      \( f(x,y) = \frac{1}{2} \left\|
        \begin{bmatrix} 10 (y-x^2) \\ 1-x \end{bmatrix} \right\|_2^2 \)
    </h2>
    <script language="javascript">
      var soln = undefined;
      var gt = undefined;
      var cm = undefined;
      var nc = [ 100, 100 ];
      var low = [ -2, -2 ];
      var high = [ 2, 2 ];
      var npts = 500;
      var count = undefined;
      var dim = 2;
      var vertices = new Array();
      var values = new Array();

      function f( x, y ) {
        var a = 10 * ( y - x * x );
        var b = 1 - x;
        return 0.5 * ( a * a + b * b );
      }
      
      function selectionSort( ) {
        for ( var j = 0; j < dim; j++ ) {
          var k=j;
          for ( var i = j + 1; i <= dim; i++ ) {
            if ( values[i] < values[k] ) k=i;
          }
          if ( k != j ) {
            var t = values[j];
            values[j] = values[k];
            values[k] = t;
            for ( var i = 0; i < dim; i ++ ) {
              var vt = vertices[j][i];
              vertices[j][i] = vertices[k][i];
              vertices[k][i] = vt;
            }
          }
        }
      } 
      
      function nelderMeadStep( ) {
//      document.getElementById("debug_textarea").value +=
//        "entering nelderMeadStep\n";
        var vave = new Array( dim );
        for ( var i = 0; i < dim; i ++ ) vave[i] = 0;
        for ( var j = 0; j < dim; j ++ ) {
          for ( var i = 0; i < dim; i ++ ) vave[i] += vertices[j][i];
        }
        for ( var i = 0; i < dim; i ++ ) vave[i] /= dim;
        var v_reflect = new Array( dim );
        for ( var i = 0; i < dim; i ++ ) {
          v_reflect[ i ] = vave[ i ] * 2 - vertices[ dim ][ i ];
        }
        var f_reflect = f( v_reflect[0], v_reflect[1] ); count++;
        if ( f_reflect < values[0] ) {
//        expand?
          var v_expand = new Array( dim );
          for ( var i = 0; i < dim; i ++ ) {
            v_expand[ i ] = vave[ i ] * 3 - vertices[ dim ][ i ] * 2;
          }
          var f_expand = f( v_expand[0], v_expand[1] ); count++;
          if ( f_expand < f_reflect ) {
            for ( var i = 0; i < dim; i ++ ) {
              vertices[dim][i] = v_expand[i];
            }
            values[dim] = f_expand;
          } else {
            for ( var i = 0; i < dim; i ++ ) {
              vertices[dim][i] = v_reflect[i];
            }
            values[dim] = f_reflect;
          }
        } else if ( f_reflect < values[ dim - 1 ] ){
//        reflect
          for ( var i = 0; i < dim; i ++ ) {
            vertices[dim][i] = v_reflect[i];
          }
          values[dim] = f_reflect;
        } else { 
          var shrink = false;
          if ( f_reflect < values[dim] ) {
//          outside contraction
            var v_oc = new Array( dim );
            for ( var i = 0; i < dim; i ++ ) {
              v_oc[ i ] = vave[ i ] * 1.5 - vertices[ dim ][ i ] * .5;
            }
            var f_oc = f( v_oc[0], v_oc[1] ); count++;
            if ( f_oc <= f_reflect ) {
              for ( var i = 0; i < dim; i ++ ) {
                vertices[dim][i] = v_oc[i];
              }
              values[dim] = f_oc;
            } else shrink = true;
          } else { 
//          inside contraction
            var v_ic = new Array( dim );
            for ( var i = 0; i < dim; i ++ ) {
              v_ic[ i ] = ( vave[ i ] + vertices[ dim ][ i ] ) * .5;
            }
            var f_ic = f( v_ic[0], v_ic[1] ); count++;
            if ( f_ic <= values[dim] ) {
              for ( var i = 0; i < dim; i ++ ) {
                vertices[dim][i] = v_ic[i];
              }
              values[dim] = f_ic;
            } else shrink = true;
          }
          if ( shrink ) {
            for ( var j = 1; j <= dim; j ++ ) {
              for ( var i = 0; i < dim; i ++ ) {
                vertices[j][i] = vertices[0][i] * 1.5 - vertices[j][i]*.5;
              }
              values[j] = f( vertices[j][0], vertices[j][1] ); count++;
            }
          }
        }
        selectionSort( );
//      document.getElementById("debug_textarea").value +=
//        "leaving nelderMeadStep\n";
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        var p = new Palette();
        cm = new Colormap( p );
        gt = new AreaGraphTool(
          document.getElementById("contour_canvas"),"contour test",
          "x", "y ", low, high, cm );
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = iterate;
        gt.watchMouse();
        gt.listen();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function iterate( e ) {
//      document.getElementById("debug_textarea").value +=
//        "entering iterate\n";
        var len = vertices.length;
        gt.watchMouse();
        if ( len < dim + 1 ) {
          var new_vertex = new Array( dim );
          new_vertex[0] = gt.mouse_coords[0];
          new_vertex[1] = gt.mouse_coords[1];
          if ( len > 0 ) {
            var dist = Math.max(
              Math.abs( new_vertex[0] - vertices[ len - 1][0] ),
              Math.abs( new_vertex[1] - vertices[ len - 1][1] ) );
            if ( dist < .001 ) return;
          }
          vertices.push( new_vertex );
          values.push( f( new_vertex[0], new_vertex[1] ) );
          if ( vertices.length < dim + 1 ) {
            return;
          }
          selectionSort( );
        } else nelderMeadStep( );
        gt.ignoreMouse();

        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.setFgColor(); // black
        gt.beginDrawing();
          gt.movePen([ vertices[0][0], vertices[0][1] ]);
          gt.drawLine([ vertices[1][0], vertices[1][1] ]);
          gt.drawLine([ vertices[2][0], vertices[2][1] ]);
          gt.drawLine([ vertices[0][0], vertices[0][1] ]);
        gt.endDrawing();
//      document.getElementById("debug_textarea").value +=
//        "leaving iterate\n";
      }
    </script>
    <canvas id="contour_canvas" width="500" height="500">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    Click mouse in contour plot to select first simplex vertex
    for Nelder-Mead
    <br>
    Hit Select button below
    <br>
    Click mouse in contour plot to select second simplex vertex
    <br>
    Hit Select button below
    <br>
    Click mouse in contour plot to select third simplex vertex
    <br>
    Hit Select button below to iterate after that
    <br>
    <input
      type="button"
      value="Select more vertices or iterate"
      onclick="iterate();"
    >
<!--
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=2
    >
    </textarea>
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
