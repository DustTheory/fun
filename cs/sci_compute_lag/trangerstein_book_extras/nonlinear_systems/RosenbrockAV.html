<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Rosenbrock minimization </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/AreaGraphTool.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script src=../plotting/Colormap.js></script>
    <script src=../plotting/Palette.js></script>
  </HEAD>
  <BODY>
    <h2>
      Rosenbrock's function
      \( \phi(x) = \frac{1}{2} \left\|
        \begin{bmatrix} 10 (x_2-x_1^2) \\ 1-x_1 \end{bmatrix} \right\|_2^2
      \)
    </h2>
    <script language="javascript">
      var soln = undefined;
      var gt = undefined;
      var cm = undefined;
      var nc = [ 100, 100 ];
      var low = [ -2, -2 ];
      var high = [ 2, 2 ];
      var len = undefined;
      var roundoff = undefined;
      var sqrtrnd = undefined;
      var npts = 500;

      function f( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        roundoff = 1;
        while ( 1 - roundoff < 1 ) roundoff *= 0.5;
        roundoff *=2.
        sqrtrnd = Math.pow( roundoff , 1. / 3. );

        var p = new Palette();
        cm = new Colormap( p );
        gt = new AreaGraphTool(
          document.getElementById("contour_canvas"),"contour test",
          "x", "y ", low, high, cm );
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = firstIteration;
        gt.watchMouse();
        gt.listen();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function firstIteration( e ) {
//      document.getElementById("debug_textarea").value +=
//        "entering firstIteration\n";
        soln = new Array( gt.mouse_coords[0], gt.mouse_coords[1] ); 
        len = new Array( 2 );
        len[ 0 ] = 1;
        len[ 1 ] = 1;
        iterate();
//      document.getElementById("debug_textarea").value +=
//        "leaving firstIteration\n";
      }

      function iterate( ) {
//      document.getElementById("debug_textarea").value +=
//        "entering iterate\n";
        if ( soln == undefined ) {
          document.getElementById("debug_textarea").value =
            "Select an initial guess before iterating\n";
          return;
        }
//      gt.setBgColor();
//      gt.newPage();
//      gt.setFgColor( );
//      gt.drawAxes();
//      gt.contourFunction( f, nc, 30 );

        var fval = f( soln[ 0 ], soln[ 1 ] );
        lineSearch( 0 );
        gt.setFgColor(1); // red
        gt.beginDrawing();
          gt.movePen( soln );
          soln[ 0 ] += len[ 0 ];
          gt.drawLine( soln );
        gt.endDrawing();

        fval = f( soln[ 0 ], soln[ 1 ] );
        lineSearch( 1 );
        gt.setFgColor(.5); // green
        gt.beginDrawing();
          gt.movePen( soln );
          soln[ 1 ] += len[ 1 ];
          gt.drawLine( soln );
        gt.endDrawing();
        fval = f( soln[ 0 ], soln[ 1 ] );
        document.getElementById("debug_textarea").value +=
          "soln,f = " + soln[ 0 ] + " " + soln[ 1 ] + " " + fval + "\n";

//      document.getElementById("debug_textarea").value +=
//        "leaving iterate\n";
      }

//    1D Nelder-Mead
      function lineSearch( dir ) {
//      document.getElementById("debug_textarea").value +=
//        "entering lineSearch\n";
        var len0 = 0.;
        var point0 = [ soln[ 0 ] , soln[ 1 ] ];
        var f0 = f( soln[0], soln[1] );
//      document.getElementById("debug_textarea").value +=
//        "soln = " + soln[ 0 ] + " " + soln[ 1 ] + "\n";
//      document.getElementById("debug_textarea").value +=
//        "f = " + f0 + "\n";

        var len1 = len[ dir ];
        var point1 = [ soln[ 0 ] , soln[ 1 ] ];
          point1[ dir ] += len1;
        var f1 = f( point1[ 0 ], point1[ 1 ] );
        if ( f0 > f1 ) { // sort
          var l = len0;
          var fl = f0;
          len0 = len1; f0 = f1;
          len1 = l; f1 = fl;
        }
        while ( f0 < f1 ) {
          var lr = 2 * len0 - len1; // reflect
          var pointr = [ soln[ 0 ], soln[ 1 ] ];
            pointr[ dir ] = soln[ dir ] + lr;
          var fr = f( pointr[ 0 ], pointr[ 1 ] );
          if ( fl < f0 ) {
            var le = 3 * len0 - 2 * len1; // expand
            var pointe = [ soln[ 0 ], soln[ 1 ] ];
              pointe[ dir ] = soln[ dir ] + le;
            var fe = f( pointe[ 0 ], pointe[ 1 ] );
            if ( fe < fr ) {
              len1 = le; f1 = fe;
            } else {
              len1 = lr; f1 = fr;
            }
          } else if ( fr < f0 ) {
            len1 = lr; f1 = fr; 
          } else {
            var shrink = false;
            if ( fr < f1 ) {
              var loc = 1.5 * len0 - 0.5 * len1; // outer contraction
              var pointoc = [ soln[ 0 ], soln[ 1 ] ];
                pointoc[ dir ] = soln[ dir ] + loc;
              var foc = f( pointoc[ 0 ], pointoc[ 1 ] );
              if ( foc <= fr ) {
                len1 = loc; f1 = foc;
              } else shrink = true;
            } else {
              var lic = 0.5 * ( len0 + len1 ); // inner contraction
              var pointic = [ soln[ 0 ], soln[ 1 ] ];
                pointic[ dir ] = soln[ dir ] + lic;
              var fic = f( pointic[ 0 ], pointic[ 1 ] );
              if ( fic <= fr ) {
                len1 = lic; f1 = fic;
              } else shrink = true;
            }
            if ( shrink ) {
              len1 = 1.5 * len0 - 0.5 * len1;
              point1 = [ soln[ 0 ] , soln[ 1 ] ];
                point1[ dir ] += len1;
              f1 = f( point1[ 0 ], point1[ 1 ] );
            }
          }
          if ( f0 > f1 ) { // sort
            l = len0; fl = f0;
            len0 = len1; f0 = f1;
            len1 = l; f1 = fl;
          }
        }
        len[ dir ] = len0;
//      document.getElementById("debug_textarea").value +=
//        "leaving lineSearch\n";
      }
    </script>
    <canvas id="contour_canvas" width="400" height="400">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    Click mouse in contour plot to select initial guess for iteration
    <br>
    Alternating variable search in red and green.
    <br>
    <input
      type="button"
      value="Choose a different initial guess"
      onclick="onStart();"
    >
    <br>
    <input
      type="button"
      value="Continue iteration"
      onclick="iterate();"
    >
<!--
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=20
    >
    </textarea>
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
