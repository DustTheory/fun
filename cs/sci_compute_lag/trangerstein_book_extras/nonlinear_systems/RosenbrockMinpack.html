<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Rosenbrock Trust Regions </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/glMatrix-0.9.5.min.js></script>
    <script src=../plotting/VolGraphTool.js></script>
    <script src=../plotting/AreaGraphTool.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script src=../plotting/Colormap.js></script>
    <script src=../plotting/Palette.js></script>
    <script src=../linear_algebra/Blas1.js></script>
    <script src=../linear_algebra/BooleanReference.js></script>
    <script src=../linear_algebra/IntReference.js></script>
    <script src=../linear_algebra/NumberReference.js></script>
    <script src=../linear_algebra/LaPack0.js></script>
    <script src=../nonlinear_systems/minpack.js></script>
<!--
    <script type="text/javascript">
      function ff( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
      }
      function webGLStart() {
        var slow = [ -1, -1 ];
        var shigh = [ 1, 1 ];
        var sncell = [ 10, 10 ];
        var sp = new Palette();
        var gt4 = new VolGraphTool(
          document.getElementById("surface_canvas"),
          "volgraphtool test", sp );
        gt4.draw2DFunction( f, slow, shigh, sncell );
      }
      
    </script>
-->
  </HEAD>
<!--
  <BODY onload="webGLStart();">
-->
  <BODY>
    <h2>
      Rosenbrock's function
      \( f( x ) =
        \begin{bmatrix} 10 (x_2-x_1^2) \\ 1-x_1 \end{bmatrix} \)
    </h2>
    <h>
      contours of \( \| f \|_2 \) ar below
    </h>
    <script language="javascript">
      var soln = undefined;
      var gt = undefined;
      var cm = undefined;
      var nc = [ 100, 100 ];
      var low = [ -2, -2 ];
      var high = [ 2, 2 ];
//    var low = [ -.3, -.3 ];
//    var high = [ .3, .3 ];
      var npts = 500;
      var tol = 1.e-15;
      var mp = undefined;

      function f( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
//      var a = x * x + y * y;
//      var b = Math.exp( x + y ) - 1.;
//      return 0.5 * ( a * a + b * b );
      }
      function minpackFcn( n, x, fvec, fjac, ldfjac, iflag,
      ioffx, iofffvec, iofffjac ) {
        if ( iflag.getValue() == 1 ) {
          fvec[ iofffvec     ] = 10. * ( x[ 1 ] - x[ 0 ] * x[ 0 ] );
          fvec[ iofffvec + 1 ] = 1. - x[ 0 ];
//        fvec[ iofffvec     ] = x[ 0 ] * x[ 0 ] + x[ 1 ] * x[ 1 ];
//        fvec[ iofffvec + 1 ] = Math.exp( x[ 0 ] + x[ 1 ] ) - 1.;
        } else if ( iflag.getValue() == 2 ) {
          fjac[ iofffjac     ] = -20. * x[ 0 ];
          fjac[ iofffjac + 1 ] = -1.;
          fjac[ iofffjac + 2 ] = 10.;
          fjac[ iofffjac + 3 ] = 0.;
//        fjac[ iofffjac     ] = 2. * x[ 0 ];
//        fjac[ iofffjac + 1 ] = Math.exp( x[ 0 ] + x[ 1 ] ) - 1.;
//        fjac[ iofffjac + 2 ] = 2 * x[ 1 ];
//        fjac[ iofffjac + 3 ] = fjac[ iofffjac + 1 ];
        }
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        mp = new Minpack();
        var p = new Palette();
        cm = new Colormap( p );
        gt = new AreaGraphTool(
          document.getElementById("contour_canvas"),"contour test",
          "x", "y ", low, high, cm );
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = firstIteration;
        gt.watchMouse();
        gt.listen();
        mp = new Minpack();
        mp.graph_tool = gt;
        mp.soln = new Array( 2 );
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function firstIteration( e ) {
//      document.getElementById("debug_textarea").value +=
//        "entering firstIteration\n";
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = firstIteration;
        soln = new Array( gt.mouse_coords[0], gt.mouse_coords[1] ); 
//      soln = new Array( -1.2, 1. );
        mp.soln = [ soln[ 0 ], soln[ 1 ] ];
        mp.hybrj1( minpackFcn, 2, soln, tol, 0 );
//      document.getElementById("debug_textarea").value +=
//        "leaving firstNewtonIteration\n";
      }
      function iterate() {
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = firstIteration;
        mp.soln = [ soln[ 0 ], soln[ 1 ] ];
        mp.hybrj1Step( minpackFcn, 2, soln, 0 );
      }
    </script>
    <br>
    <canvas id="contour_canvas" width="500" height="500">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    Click mouse in contour plot to select starting point
    <br>
    Newton direction in blue, steepest descent in red, dogleg in green
    <br>
    <input
      type="button"
      value="Take Step"
      onclick="iterate();"
    >
    <br>
    <input
      type="button"
      value="Start Over"
      onclick="onStart();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=5
    >
    </textarea>
<!--
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
