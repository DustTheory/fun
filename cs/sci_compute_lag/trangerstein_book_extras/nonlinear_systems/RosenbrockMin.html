<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Rosenbrock minimization </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
<!--
    <script src=../plotting/glMatrix-0.9.5.min.js></script>
    <script src=../plotting/VolGraphTool.js></script>
-->
    <script src=../plotting/AreaGraphTool.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script src=../plotting/Colormap.js></script>
    <script src=../plotting/Palette.js></script>
<!--
    <script src=../linear_algebra/Complex.js></script>
    <script type="text/javascript">
      function ff( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
      }
      function webGLStart() {
        var slow = [ -1, -1 ];
        var shigh = [ 1, 1 ];
        var sncell = [ 10, 10 ];
        var sp = new Palette();
        var gt4 = new VolGraphTool(
          document.getElementById("surface_canvas"),
          "volgraphtool test", sp );
        gt4.draw2DFunction( f, slow, shigh, sncell );
      }
    </script>
-->
  </HEAD>
<!--
  <BODY onload="webGLStart();">
-->
  <BODY>
    <h2>
      Rosenbrock's function
      \( f(x,y) = \frac{1}{2} \left\|
        \begin{bmatrix} 10 (y-x^2) \\ 1-x \end{bmatrix} \right\|_2^2 \)
    </h2>
    <script language="javascript">
      var soln = undefined;
      var fval = undefined;
      var gfval = undefined;
      var steepest_descent = undefined;
      var Hfval = undefined;
      var newton = undefined;
      var back_track_sd = undefined;
      var back_track_n = undefined;
      var tol_sd = undefined;
      var tol_n = undefined;
      var found_sd = undefined;
      var found_n = undefined;
      var dot_sd = undefined;
      var dot_n = undefined;
      var sigma_sd_1 = undefined;
      var sigma_sd_1 = undefined;
      var sigma_n_1 = undefined;
      var sigma_n_1 = undefined;
      var len_sd_1 = undefined;
      var len_sd_2 = undefined;
      var len_n_1 = undefined;
      var len_n_2 = undefined;
      var gt = undefined;
      var gt2 = undefined;
      var gt3 = undefined;
//    var gt4 = undefined;
      var axis_sd = undefined;
      var axis_n = undefined;
      var cm = undefined;
      var nc = [ 100, 100 ];
      var low = [ -2, -2 ];
      var high = [ 2, 2 ];
      var len_sd = undefined;
      var len_n = undefined;
      var roundoff = undefined;
      var sqrtrnd = undefined;
      var npts = 500;
//    Golthe line search-Armijo Principle:
      var alpha = .01;
      var beta = .75;

      function f( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
      }
      function gf( x, y ) { // gradient of f
        var a=10*(y-x*x);
        var b=1-x;
        return new Array( -20 * x * a - b, 10 * a );
      }
      function Hf( x, y ) { // Hessian of f
        var a=10*(y-x*x);
        var b=1-x;
        return new Array( -20 * a + 400 * x * x + 1, - 200 * x,
                         -200 * x, 100 );
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        roundoff = 1;
        while ( 1 - roundoff < 1 ) roundoff *= 0.5;
        roundoff *=2.
        sqrtrnd = Math.sqrt( roundoff );

        var p = new Palette();
        cm = new Colormap( p );
        gt = new AreaGraphTool(
          document.getElementById("contour_canvas"),"contour test",
          "x", "y ", low, high, cm );
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = firstIteration;
        gt.watchMouse();
        gt.listen();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function firstIteration( e ) {
//      document.getElementById("debug_textarea").value +=
//        "entering firstIteration\n";
        soln = new Array( gt.mouse_coords[0], gt.mouse_coords[1] ); 
        fval = f( soln[0], soln[1] );
        gfval = gf( soln[0], soln[1] );
        steepest_descent = new Array( - gfval[0], - gfval[1] );

        Hfval = Hf( soln[0], soln[1] );
        var det = Hfval[ 0 ] * Hfval[ 3 ] - Hfval[ 1 ] * Hfval[ 2 ];
        newton = new Array( 
          ( Hfval[ 2 ] * gfval[ 1 ] - Hfval[ 3 ] * gfval[ 0 ] ) / det,
          ( Hfval[ 1 ] * gfval[ 0 ] - Hfval[ 0 ] * gfval[ 1 ] ) / det );

        var len0 = ( steepest_descent[ 0 ] > 0 ?
          ( high[ 0 ] - soln[ 0 ] ) / steepest_descent[ 0 ] :
          ( soln[ 0 ] - low[ 0 ] ) / ( - steepest_descent[ 0 ] ) );
        var len1 = ( steepest_descent[ 1 ] > 0 ?
          ( high[ 1 ] - soln[ 1 ] ) / steepest_descent[ 1 ] :
          ( soln[ 1 ] - low[ 1 ] ) / ( - steepest_descent[ 1 ] ) );
        axis_sd = Math.min( len0, len1 );
        gt.setFgColor(1); // red
        gt.beginDrawing();
          gt.movePen( soln );
          gt.drawLine( [ soln[ 0 ] + steepest_descent[ 0 ] * axis_sd,
                         soln[ 1 ] + steepest_descent[ 1 ] * axis_sd ] );
        gt.endDrawing();
        var ylo = Number.MAX_VALUE;
        var yhi = -Number.MAX_VALUE;
        var ds_sd = axis_sd / npts;
        var s = 0;
        for ( var i = 0; i <= npts; i ++, s += ds_sd ) {
          var fnew = f( soln[ 0 ] + steepest_descent[ 0 ] * s,
                        soln[ 1 ] + steepest_descent[ 1 ] * s );
          ylo = Math.min( ylo, fnew );
          yhi = Math.max( yhi, fnew );
        }
        gt2 = new XYGraphTool(
          document.getElementById("steepest_descent_canvas"),
          "steepest descent test", "x", "y ", 0, axis_sd,
          ylo - fval, yhi - fval );

        len0 = ( newton[ 0 ] > 0 ?
          ( high[ 0 ] - soln[ 0 ] ) / newton[ 0 ] :
          ( soln[ 0 ] - low[ 0 ] ) / ( - newton[ 0 ] ) );
        len1 = ( newton[ 1 ] > 0 ?
          ( high[ 1 ] - soln[ 1 ] ) / newton[ 1 ] :
          ( soln[ 1 ] - low[ 1 ] ) / ( - newton[ 1 ] ) );
        axis_n = Math.min( len0, len1 );
        gt.setFgColor(.5); // green
        gt.beginDrawing();
          gt.movePen( soln );
          gt.drawLine( [ soln[ 0 ] + newton[ 0 ] * axis_n,
                         soln[ 1 ] + newton[ 1 ] * axis_n ] );
        gt.endDrawing();
        ylo = Number.MAX_VALUE;
        yhi = -Number.MAX_VALUE;
        ds_n = axis_n / npts;
        s = 0;
        for ( var i = 0; i <= npts; i ++, s += ds_n ) {
          var fnew = f( soln[ 0 ] + newton[ 0 ] * s,
                        soln[ 1 ] + newton[ 1 ] * s );
          ylo = Math.min( ylo, fnew );
          yhi = Math.max( yhi, fnew );
        }
        gt3 = new XYGraphTool(
          document.getElementById("newton_canvas"),
          "newton test", "x", "y ", 0, axis_n, ylo - fval, yhi - fval );

        back_track_sd = undefined;
        back_track_n = undefined;
        found_sd = false;
        found_n = false;
        lineSearch();

//      document.getElementById("debug_textarea").value +=
//        "leaving firstIteration\n";
      }

      function lineSearch( ) {
//      document.getElementById("debug_textarea").value +=
//        "entering lineSearch\n";
        if ( soln == undefined ) {
          document.getElementById("debug_textarea").value =
            "Select an initial guess before iterating the line search\n";
          return;
        }

        gt2.setBgColor( "white" );
        gt2.newPage();
        gt2.setFgColor( "black" );
        gt2.drawAxes();
        gt2.setFgColor( "red"  );
        gt2.beginDrawing();
          gt2.movePen( 0, 0 );
          s = 0;
          var ds_sd = axis_sd / npts;
          for ( var i = 0; i <= npts; i ++, s += ds_sd ) {
            var fnew = f( soln[ 0 ] + steepest_descent[ 0 ] * s,
                          soln[ 1 ] + steepest_descent[ 1 ] * s );
            gt2.drawLine( s, fnew - fval );
          }
        gt2.endDrawing();
        dot_sd = gfval[ 0 ] * steepest_descent[ 0 ]
                + gfval[ 1 ] * steepest_descent[ 1 ];
        gt2.setFgColor( "blue" );
        gt2.beginDrawing();
          gt2.movePen( 0, 0 );
          gt2.drawLine( gt2.user_xhi, alpha * dot_sd * gt2.user_xhi ); 
        gt2.endDrawing();
        gt2.setFgColor( "yellow" );
        gt2.beginDrawing();
          gt2.movePen( 0, 0 );
          gt2.drawLine( gt2.user_xhi, beta * dot_sd * gt2.user_xhi ); 
        gt2.endDrawing();

        gt3.setBgColor( "white" );
        gt3.newPage();
        gt3.setFgColor( "black" );
        gt3.drawAxes();
        gt3.setFgColor( "green"  );
        gt3.beginDrawing();
          gt3.movePen( 0, 0 );
          ds_n = axis_n / npts;
          s = 0;
          for ( var i = 0; i <= npts; i ++, s += ds_n ) {
            var fnew = f( soln[ 0 ] + newton[ 0 ] * s,
                          soln[ 1 ] + newton[ 1 ] * s );
            gt3.drawLine( s, fnew - fval );
          }
        gt3.endDrawing();
        dot_n = gfval[ 0 ] * newton[ 0 ]
              + gfval[ 1 ] * newton[ 1 ];
        gt3.setFgColor( "blue" );
        gt3.beginDrawing();
          gt3.movePen( 0, 0 );
          gt3.drawLine( gt3.user_xhi, alpha * dot_n * gt3.user_xhi ); 
        gt3.endDrawing();
        gt3.setFgColor( "yellow" );
        gt3.beginDrawing();
          gt3.movePen( 0, 0 );
          gt3.drawLine( gt3.user_xhi, beta * dot_n * gt3.user_xhi ); 
        gt3.endDrawing();

        if ( back_track_sd == undefined ) {
          tol_sd = - ( 1 - alpha ) * dot_sd;
          len_sd = len_sd_1 = 1;
          len_sd_2 = 1;
          sigma_sd_1 = f( soln[ 0 ] + steepest_descent[ 0 ],
                              soln[ 1 ] + steepest_descent[ 1 ] )
                         - fval - dot_sd;
          sigma_sd_2 = sigma_sd_1;
          len_sd_2 = - dot_sd / ( 2 * sigma_sd_1 );
          document.getElementById("debug_textarea").value =
            "minimum of steepest descent quadratic = " + len_sd_2 + "\n";
          if ( sigma_sd_1 > tol_sd ) {
            back_track_sd = true;
            len_sd_2 = Math.min( 0.5, Math.max( 0.1, len_sd_2 ) );
          } else {
            tol_sd = - ( 1 - beta ) * dot_sd;
            found_sd = ( sigma_sd_1 >= tol_sd );
            back_track_sd = false;
            len_sd_2 = Math.max( 2. , Math.min( 10. , len_sd_2 ) );
          }
          if ( ! found_sd ) {
            gt2.setFgColor( "black"  );
            gt2.beginDrawing();
              gt2.movePen( 0, 0 );
              s = ds_sd;
              for ( var i = 1; i <= npts; i ++, s += ds_sd ) {
                var fnew = s * ( dot_sd + s * sigma_sd_1 );
                gt2.drawLine( s, fnew );
              }
            gt2.endDrawing();
          }
          sigma_sd_2 = 
            ( f( soln[ 0 ] + steepest_descent[ 0 ] * len_sd_2,
                 soln[ 1 ] + steepest_descent[ 1 ] * len_sd_2 )
              - fval - dot_sd * len_sd_2 ) / ( len_sd_2 * len_sd_2 );
          if ( ! found_sd ) {
            if (back_track_sd ) {
              found_sd = ( sigma_sd_2 <= tol_sd / len_sd_2 );
            } else {
              found_sd = ( sigma_sd_2 >= tol_sd / len_sd_2 );
            }
            len_sd = len_sd_2;
          }

          if ( dot_n < 0. ) {
            tol_n = - ( 1 - alpha ) * dot_n;
            len_n = len_n_1 = 1;
            len_n_2 = 1;
            sigma_n_1
              = f( soln[ 0 ] + newton[ 0 ], soln[ 1 ] + newton[ 1 ] )
              - fval - dot_n;
            sigma_n_2 = sigma_n_1;
            len_n_2 = - dot_n / ( 2 * sigma_n_1 );
            document.getElementById("debug_textarea").value +=
              "minimum of Newton quadratic = " + len_n_2 + "\n";
            if ( sigma_n_2 > tol_n ) {
              back_track_n = true;
              len_n_2 = Math.min( 0.5, Math.max( 0.1, len_n_2 ) );
            } else {
              tol_n = - ( 1 - beta ) * dot_n;
              found_n = ( sigma_n_1 >= tol_n );
              back_track_n = false;
              len_n_2 = Math.max( 2. , Math.min( 10. , len_n_2 ) );
            }
            if ( ! found_n ) {
              gt3.setFgColor( "black"  );
              gt3.beginDrawing();
                gt3.movePen( 0, 0 );
                s = ds_n;
                for ( var i = 1; i <= npts; i ++, s += ds_n ) {
                  var fnew = s * ( dot_n + s * sigma_n_1 );
                  gt3.drawLine( s, fnew );
                }
              gt3.endDrawing();
            }
            sigma_n_2 = 
              ( f( soln[ 0 ] + newton[ 0 ] * len_n_2,
                   soln[ 1 ] + newton[ 1 ] * len_n_2 )
                - fval - dot_n * len_n_2 ) / ( len_n_2 * len_n_2 );
            if ( ! found_n ) {
              if ( back_track_n ) {
                found_n = ( sigma_n_2 <= tol_n / len_n_2 );
              } else {
                found_n = ( sigma_n_2 >= tol_n / len_n_2 );
              }
              len_n = len_n_2;
            }
          } else {
            document.getElementById("debug_textarea").value =
              "Newton direction is not a descent direction\n";
          }
        } else {
          if ( found_sd ) {
            document.getElementById("debug_textarea").value =
              "steepest descent step length found to be = " + len_sd + "\n";
          } else {
            var len_sd_3 = undefined;
            var dlen_sd = len_sd_1 - len_sd_2;
            var a_sd = 3 * ( sigma_sd_1 - sigma_sd_2 ) / dlen_sd;
            if ( a_sd == 0. ) {
              var b_sd = - ( len_sd_2 * sigma_sd_1 - len_sd_1 * sigma_sd_2 )
                       / dlen_sd;
              len_sd_3 = ( b_sd == 0 ? len_sd_2 : - dot_sd / ( 2 * b_sd ) );
            } else {
              var b_sd = ( len_sd_2 * sigma_sd_1 - len_sd_1 * sigma_sd_2 )
                / ( a_sd *dlen_sd );
              var c_sd = dot_sd / a_sd;
              var d_sd = b_sd * b_sd - c_sd;
              if ( d_sd < 0. ) len_sd_3 = len_sd_2;
              else {
                d_sd = Math.sqrt( d_sd );
                var root1 = ( b_sd >= 0. ? b_sd + d_sd : b_sd - d_sd );
                var root2 = ( root1 == 0. ? 0. : c_sd / root1 );
                var t1 = ( c_sd + root1 * ( - b_sd * 2. + root1 ) ) * a_sd;
                var t2 = ( c_sd + root2 * ( - b_sd * 2. + root2 ) ) * a_sd;
                len_sd_3 = ( a_sd > 0 ? Math.max( root1, root2) : 
                  Math.min( root1, root2 ));
              }
            }
            var A_sd = ( sigma_sd_1 - sigma_sd_2 ) / dlen_sd;
            var B_sd = - ( len_sd_2 * sigma_sd_1 - len_sd_1 * sigma_sd_2 )
                     / dlen_sd;
            len_sd_1 = len_sd_2;
            sigma_sd_1 = sigma_sd_2;
            document.getElementById("debug_textarea").value =
              "minimum of steepest descent cubic = " + len_sd_3 + "\n";
            if ( back_track_sd ) {
              len_sd_2 = Math.min( len_sd_2 / 2 , Math.max( len_sd_2 / 10,
                len_sd_3 ) );
            } else {
              len_sd_2 = Math.max( len_sd_2 * 2 , Math.min( len_sd_2 * 10,
                len_sd_3 ) );
            }
            gt2.setFgColor( "black"  );
            gt2.beginDrawing();
              gt2.movePen( 0, 0 );
              s = ds_sd;
              for ( var i = 1; i <= npts; i ++, s += ds_sd ) {
                var fnew = s * ( dot_sd + s * ( B_sd + s * A_sd ) );
                gt2.drawLine( s, fnew );
              }
            gt2.endDrawing();
            sigma_sd_2 = 
              ( f( soln[ 0 ] + steepest_descent[ 0 ] * len_sd_2,
                   soln[ 1 ] + steepest_descent[ 1 ] * len_sd_2 )
                - fval - dot_sd * len_sd_2 ) / ( len_sd_2 * len_sd_2 );
            if ( back_track_sd ) {
              found_sd = ( sigma_sd_2 <= tol_sd / len_sd_2 );
            } else {
              found_sd = ( sigma_sd_2 >= tol_sd / len_sd_2 );
            }
            len_sd = len_sd_2;
          }

          if ( dot_n < 0. ) {
            if ( found_n ) {
              document.getElementById("debug_textarea").value +=
                "Newton step length found to be = " + len_n + "\n";
            } else {
              var len_n_3 = undefined;
              var dlen_n = len_n_1 - len_n_2;
              var a_n = 3 * ( sigma_n_1 - sigma_n_2 ) / dlen_n;
              if ( a_n == 0. ) {
                var b_n = ( len_n_2 * sigma_n_1 - len_n_1 * sigma_n_2 )
                         / dlen_n;
                len_n_3 = ( b_n == 0 ? len_n_2 : - dot_n / ( 2 * b_n ) );
              } else {
                var b_n = - ( len_n_2 * sigma_n_1 - len_n_1 * sigma_n_2 )
                  / ( a_n *dlen_n );
                var c_n = dot_n / a_n;
                var d_n = b_n * b_n - c_n;
                if ( d_n < 0. ) len_n_3 = len_n_2;
                else {
                  d_n = Math.sqrt( d_n );
                  var root1 = ( b_n >= 0. ? b_n + d_n : b_n - d_n );
                  var root2 = ( root1 == 0. ? 0. : c_n / root1 );
                  len_n_3 = ( a_n > 0 ? Math.max( root1, root2 ) : 
                    Math.min( root1, root2 ) );
                }
              }
              document.getElementById("debug_textarea").value +=
                "minimum of newton cubic = " + len_n_3 + "\n";
              len_n_1 = len_n_2;
              sigma_n_1 = sigma_n_2;
              if ( back_track_n ) {
                len_n_2 = Math.min( len_n_2 / 2 , Math.max( len_n_2 / 10,
                  len_n_3 ) );
              } else {
                len_n_2 = Math.max( len_n_2 * 2 , Math.min( len_n_2 * 10,
                  len_n_3 ) );
              }
              gt3.setFgColor( "black"  );
              gt3.beginDrawing();
                gt3.movePen( 0, 0 );
                s = ds_n;
                for ( var i = 1; i <= npts; i ++, s += ds_n ) {
                  var fnew = s * ( dot_n + s * ( - sigma_n_1 * len_n_2
                    + sigma_n_2 * len_n_1 + s * ( sigma_n_1 - sigma_n_2 ) )
                    / dlen_n );
                  gt3.drawLine( s, fnew );
                }
              gt3.endDrawing();
              sigma_n_2 = 
                ( f( soln[ 0 ] + newton[ 0 ] * len_n_2,
                     soln[ 1 ] + newton[ 1 ] * len_n_2 )
                  - fval - dot_n * len_n_2 ) / ( len_n_2 * len_n_2 );
              found_n = ( back_track_n ? sigma_n_2 <= tol_n / len_n_2
                : sigma_n_2 >= tol_n / len_n_2 );
              len_n = len_n_2;
            }
          }
        }
//      document.getElementById("debug_textarea").value +=
//        "leaving lineSearch\n";
      }
    </script>
    <canvas id="contour_canvas" width="400" height="400">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="surface_canvas" width="400" height="400">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    Click mouse in contour plot to select initial guess for iteration
    <br>
    Steepest descent direction in red, Newton in green
    <br>
    <canvas id="steepest_descent_canvas" width="400" height="200">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <canvas id="newton_canvas" width="400" height="200">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    Line searches along the steepest descent direction (left plot) and
    Newton direction (right plot)
    <br>
    Objective function in red (steepest descent) or green (Newton)
    <br>
    Goldstein-Armijo principle in blue and yellow
    <br>
    <input
      type="button"
      value="Choose a different initial guess"
      onclick="onStart();"
    >
    <br>
    <input
      type="button"
      value="Continue line search"
      onclick="lineSearch();"
    >
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=3
    >
    </textarea>
<!--
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
