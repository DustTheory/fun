<HTML>
  <HEAD>
    <meta charset="UTF-8">
    <TITLE> Rosenbrock Trust Regions </TITLE>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script src=../plotting/glMatrix-0.9.5.min.js></script>
    <script src=../plotting/VolGraphTool.js></script>
    <script src=../plotting/AreaGraphTool.js></script>
    <script src=../plotting/XYGraphTool.js></script>
    <script src=../plotting/Colormap.js></script>
    <script src=../plotting/Palette.js></script>
    <script src=../linear_algebra/Complex.js></script>
<!--
    <script type="text/javascript">
      function ff( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
      }
      function webGLStart() {
        var slow = [ -1, -1 ];
        var shigh = [ 1, 1 ];
        var sncell = [ 10, 10 ];
        var sp = new Palette();
        var gt4 = new VolGraphTool(
          document.getElementById("surface_canvas"),
          "volgraphtool test", sp );
        gt4.draw2DFunction( f, slow, shigh, sncell );
      }
      
    </script>
-->
  </HEAD>
<!--
  <BODY onload="webGLStart();">
-->
  <BODY>
    <h2>
      Rosenbrock's function
      \( \phi(x) = \frac{1}{2} \left\|
        \begin{bmatrix} 10 (x_2-x_1^2) \\ 1-x_1 \end{bmatrix} \right\|_2^2
      \)
    </h2>
    <script language="javascript">
      var soln = undefined;
      var gt = undefined;
      var cm = undefined;
      var nc = [ 100, 100 ];
      var low = [ -2, -2 ];
      var high = [ 2, 2 ];
      var roundoff = undefined;
      var sqrtrnd = undefined;
      var npts = 500;

      function f( x, y ) {
        var a=10*(y-x*x);
        var b=1-x;
        return 0.5 * ( a * a + b * b );
      }
      function gf( x, y ) { // gradient of f
        var a=10*(y-x*x);
        var b=1-x;
        return new Array( -20 * x * a - b, 10 * a );
      }
      function Hf( x, y ) { // Hessian of f
        var a=10*(y-x*x);
        var b=1-x;
        return new Array( -20 * a + 400 * x * x + 1, - 200 * x,
                         -200 * x, 100 );
      }
      function choldecomp( A, maxoffl ) {
        var L = new Array( 4 );
        for ( var i = 0; i < 4; i ++ ) L[ i ] = A[ i ];
        var minl = maxoffl * Math.sqrt( sqrtrnd );
        if ( maxoffl <= 0 ) {
          maxoffl = Math.max( Math.abs( L[ 0 ] ), Math.abs( L[ 3 ] ) );
        }
        var minl2 = maxoffl * sqrtrnd;
        var mu = 0;

        var minlkk = Math.max( Math.abs( L[1] ) / maxoffl, minl );
        if ( L[0] > minlkk * minlkk ) L[0] = Math.sqrt( L[0] );
        else {
          minlkk = Math.max( minlkk, minl2 );
          mu = Math.max( mu, minlkk * minlkk - L[0] );
          L[0] = minlkk;
        }
        L[1] /= L[0];

        L[3] = L[3] - L[1] * L[1];
        minlkk = minl;
        if ( L[3] > minlkk * minlkk ) L[3] = Math.sqrt( L[3] );
        else {
          minlkk = Math.max( minlkk, minl2 );
          mu = Math.max( mu, minlkk * minlkk - L[3] );
          L[3] = minlkk;
        }
        return mu;
      }
      function modelhess( A ) {
        var maxdiag = Math.max( A[ 0 ], A[ 3 ] );
        var mindiag = Math.min( A[ 0 ], A[ 3 ] );
        var maxposdiag = Math.max( 0, maxdiag );
        var mu = 0;
        if ( mindiag < sqrtrnd * maxposdiag ) {
          mu = 2 * ( maxposdiag - mindiag ) * sqrtrnd - mindiag;
          maxdiag += mu;
        }
        var k = -1;
        var maxoff = Math.abs( A[ 1 ] );
        if ( maxoff * ( 1 + 2 * sqrtrnd ) > maxdiag ) {
          mu += ( maxoff - maxdiag) + 2 * sqrtrnd * maxoff;
          maxdiag = maxoff * ( 1 + 2 * sqrtrnd );
        }
        if ( maxdiag <= 0 ) {
          mu = 1;
          maxdiag = 1;
        }
        if ( mu > 0 ) {
          A[ 0 ] += mu;
          A[ 3 ] += mu;
        }
        maxoffl = Math.sqrt( Math.max( maxdiag, maxoff / 2 ) );
        var maxadd = choldecomp( A, maxoffl );
        if ( maxadd > 0 ) {
          var maxev = A[0];
          var minev = A[0];
          var offrow = Math.abs( A[1] );
          maxev = Math.max( maxev, A[0] + offrow );
          minev = Math.min( minev, A[0] - offrow );
          maxev = Math.max( maxev, A[3] + offrow );
          minev = Math.min( minev, A[3] - offrow );
          var sdd = ( maxev - minev ) * sqrtrnd - minev;
          sdd = Math.max( sdd, 0 );
          var mu2 = Math.min( maxadd, sdd );
          A[0] += mu2;
          A[3] += mu2;
          mu += mu2;
        }
//      maxadd = choldecomp( A, maxoffl );
        return mu;
      }

      function onStart() {
//      document.getElementById("debug_textarea").value +=
//        "entering onStart\n";
        roundoff = 1;
        while ( 1 - roundoff < 1 ) roundoff *= 0.5;
        roundoff *=2.
        sqrtrnd = Math.sqrt( roundoff );

        var p = new Palette();
        cm = new Colormap( p );
        gt = new AreaGraphTool(
          document.getElementById("contour_canvas"),"contour test",
          "x", "y ", low, high, cm );
        gt.setBgColor();
        gt.newPage();
        gt.setFgColor( );
        gt.drawAxes();
        gt.contourFunction( f, nc, 30 );
        gt.mouseUp = firstIteration;
        gt.watchMouse();
        gt.listen();
//      document.getElementById("debug_textarea").value +=
//        "leaving onStart\n";
      }

      function firstIteration( e ) {
//      document.getElementById("debug_textarea").value +=
//        "entering firstIteration\n";
        soln = new Array( gt.mouse_coords[0], gt.mouse_coords[1] ); 
//      soln[0] = 0.5; soln[1] = 1.;
        var gfval = gf( soln[0], soln[1] );
        var steepest_descent = new Array( - gfval[0], - gfval[1] );

        var Hfval = Hf( soln[0], soln[1] );
        var mu = modelhess( Hfval );
        Hfval = Hf( soln[0], soln[1] );
        Hfval[ 0 ] += mu;
        Hfval[ 3 ] += mu;
        var det = Hfval[ 0 ] * Hfval[ 3 ] - Hfval[ 1 ] * Hfval[ 2 ];
        var newton = new Array( 
          ( Hfval[ 2 ] * gfval[ 1 ] - Hfval[ 3 ] * gfval[ 0 ] ) / det,
          ( Hfval[ 1 ] * gfval[ 0 ] - Hfval[ 0 ] * gfval[ 1 ] ) / det );

        var Hg = [
          Hfval[0] * steepest_descent[0] + Hfval[2] * steepest_descent[1],
          Hfval[1] * steepest_descent[0] + Hfval[3] * steepest_descent[1] ];
        var steepest_descent_norm =
          ( steepest_descent[0] * steepest_descent[0]
          + steepest_descent[1] * steepest_descent[1 ] );
        var alf = steepest_descent_norm
          / ( steepest_descent[0] * Hg[0] + steepest_descent[1] * Hg[1] );
        steepest_descent_norm = Math.sqrt( steepest_descent_norm );
        var cauchy_norm = steepest_descent_norm * alf;
        var newton_norm =
          Math.sqrt( newton[0] * newton[0] + newton[1] * newton[1] );

        gt.setFgColor(1); // red
        gt.beginDrawing();
          gt.movePen( soln );
          gt.drawLine( [ soln[ 0 ] + steepest_descent[ 0 ] * alf,
                         soln[ 1 ] + steepest_descent[ 1 ] * alf ] );
        gt.endDrawing();
        gt.setFgColor(.5); // green
        gt.beginDrawing();
          gt.movePen( soln );
          gt.drawLine( [ soln[ 0 ] + newton[ 0 ] ,
                         soln[ 1 ] + newton[ 1 ] ] );
        gt.endDrawing();

        if ( newton_norm > steepest_descent_norm * alf ) {
          gt.setBgColor();
          gt.newPage();
          gt.setFgColor( );
          gt.drawAxes();
          gt.contourFunction( f, nc, 30 );

          var radius =
            ( 2 * newton_norm + steepest_descent_norm * alf ) / 3;
          var theta = 0;
          var dtheta = 2 * Math.PI / npts;
          gt.setFgColor( );
          gt.beginDrawing(); // trust region
            gt.movePen( [ soln[0] + radius, soln[1] ] );
            for ( var n = 1; n <= npts; n ++, theta += dtheta ) {
              gt.drawLine( [ soln[0] + Math.cos( theta ) * radius,
                              soln[1] + Math.sin( theta ) * radius ] );
            }
          gt.endDrawing();
          gt.setFgColor(.5); // green
          gt.beginDrawing();
            gt.movePen( soln );
            gt.drawLine( [ soln[ 0 ] + newton[ 0 ] ,
                            soln[ 1 ] + newton[ 1 ] ] );
          gt.endDrawing();
          gt.setFgColor(1); // red
          gt.beginDrawing();
            gt.movePen( soln );
            gt.drawLine( [ soln[ 0 ] + steepest_descent[ 0 ] * alf,
                            soln[ 1 ] + steepest_descent[ 1 ] * alf ] );
          gt.endDrawing();

          var gamma = steepest_descent_norm * steepest_descent_norm * alf
            / ( steepest_descent[0] * newton[0]
              + steepest_descent[1] * newton[1] );
          var eta = ( 4 * gamma + 1 ) / 5;
          var dif = [ newton[0] * eta - steepest_descent[0] * alf,
                      newton[1] * eta - steepest_descent[1] * alf ];
          var norm_dif = Math.sqrt( dif[0] * dif[0] + dif[1] * dif[1] );
          dif = [ dif[0] / norm_dif, dif[1] / norm_dif ];
          var dot = ( dif[0] * steepest_descent[0]
                    + dif[1] * steepest_descent[1] ) * alf;
          var t = - dot + Math.sqrt( dot * dot
            + ( radius - steepest_descent_norm * alf )
            * ( radius + steepest_descent_norm * alf ) );
          gt.setFgColor(0); // blue
          gt.beginDrawing();
            gt.movePen( [ soln[ 0 ] + steepest_descent[ 0 ] * alf,
                           soln[ 1 ] + steepest_descent[ 1 ] * alf ] );
            gt.drawLine( [ soln[ 0 ] + newton[ 0 ] * eta,
                            soln[ 1 ] + newton[ 1 ] * eta ] );
          gt.endDrawing();
        }
//      document.getElementById("debug_textarea").value +=
//        "leaving firstNewtonIteration\n";
      }
    </script>
    <canvas id="contour_canvas" width="500" height="500">
      Apparently, your browser does not support the HTML5
      <code>&lt;canvas&gt;</code> element
    </canvas>
    <br>
    Click mouse in contour plot to select center of trust region
    <br>
    Cauchy descent direction in red, modified Newton in green,
      dogleg in blue
    <br>
    Trust region radius is always selected so that the scaled Newton step
      is inside the trust region
    <br>
    <input
      type="button"
      value="Start Over"
      onclick="onStart();"
    >
<!--
    <br>
    <textarea
      id="debug_textarea"
      cols=100
      rows=2
    >
    </textarea>
-->
    <script language="javascript"> onStart(); </script>
  </BODY>
</HTML>
